%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% takao kotani
%         Department of applied physics and materials, Tottori university,
% E-mail  takaokotani@gmail.com
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[twocolumn,showpacs,preprintnumbers,amsmath,amssymb,floatfix]{revtex4-1}
%\documentclass[preprint,showpacs,preprintnumbers,amsmath,amssymb,linenumbers]{revtex4-1}

% Some other (several out of many) possibilities
%\documentclass[aps,prl,preprint,groupedaddress,showpacs]{revtex4}
%\documentclass[aps,prl,twocolumn,superscriptaddress,showpacs]{revtex4}
%\documentclass[aps,prb,preprint,superscriptaddress,showpacs]{revtex4}

\usepackage{graphicx}% Include figure files
\usepackage{longtable}
\usepackage{dcolumn}% Align table columns on decimal point
\usepackage{bm}% bold math
%\usepackage{pst-all}      % From PSTricks
\usepackage{fancybox}
%\topmargin=.0cm
%\nofiles
\newcommand{\rou}[1]{\noindent------------------------------------------------------------------------------------------------------------
\noindent{\bf \large #1}}
\newcommand{\fl}[1]{\noindent{\sf $\bullet$ #1\index{\sf #1}} : }
\newcommand{\fx}[1]{\subsection{\sf #1\index{\sf #1}}}
\newcommand{\ssx}[1]{\subsection{\bf #1\index{\bf #1}}}
\newcommand{\ssxx}[2]{\subsection{\bf #1\index{\bf #2}}}
\newcommand{\infiles}{\noindent\fbox{Input files}}
\newcommand{\outfiles}{\noindent\fbox{Output files}}
\newcommand{\GW}{$GW$}
\newcommand{\GWinput}{{\sf GWinput}\ }
\newcommand{\GWIN}{{\sf GWIN}\ }

\newcommand{\gbox}[1]{\noindent{\color{Green}\fbox{\parbox{260mm}{#1}}}}
\newcommand{\rbox}[1]{\noindent{\color{Red}\fbox{\parbox{260mm}{#1}}}}
\newcommand{\obox}[1]{\noindent{\color{Orange}\fbox{\parbox{260mm}{#1}}}}
\newcommand{\cyanbox}[1]{\noindent{\color{Cyan}\fbox{\parbox{260mm}{#1}}}}
\newcommand{\bluebox}[1]{\noindent{\color{Blue}\fbox{\parbox{260mm}{#1}}}}

\newcommand{\keyw}[1]{\fbox{\tt #1}}
\newcommand{\innera}[1]{{[\![#1]\!]_{R_a}}}
\newcommand{\bfq}{{\bf q}}
\newcommand{\bfk}{{\bf k}}
\newcommand{\bfr}{{\bf r}}
\newcommand{\hbfr}{\hat{\bf r}}
\newcommand{\bfQ}{{\bf Q}}
\newcommand{\bfT}{{\bf T}}
\newcommand{\bfG}{{\bf G}}
\newcommand{\bfR}{{\bf R}}
\newcommand{\ds}{\displaystyle}

\newcommand{\exe}[1]{{\bf #1}}
\newcommand{\io}[1]{{\sf  #1}}
\newcommand{\raw}[1]{{\tt #1}}
\newcommand{\repp}[1]{p.\pageref{#1}}

\newcommand{\refeq}[1]{Eq.~(\ref{#1})}
\newcommand{\reffig}[1]{Fig.\ref{#1}}

\newcommand{\commentout}[1]{\ \\ \noindent xxxxxxxxxx comment out. from
here xxxxxxxxxxxxxxx\\ #1 \\ xxxxxxxxxx to here xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\\}

\newcommand{\smH}{{\mathcal H}}
\newcommand{\YY}{{\cal Y}}
\newcommand{\GG}{{\cal G}}

\newcounter{Alist}
\newcommand{\ul}[1]{\underline{#1}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\ocite}[1]{\cite{#1}}


\newcommand{\ispone}{}
\newcommand{\isptwo}{}
\newcommand{\ooplus}{\oplus}
\newcommand{\oominus}{\ominus}

%\def\psibar{\bar{\psi}}
%\def\psidotbar{\dot{\bar{\psi}}}
%\def\scgw{{sc{\em GW}}}
\def\tphi{{\tilde{\phi}}}
\def\calR{{\cal A}}
\def\qsgw{QS{\em GW}}
\def\ldagw{{lda{\em GW}}}
\def\GLDA{{G^{\rm LDA}}}
\def\WLDA{{W^{\rm LDA}}}
\def\ekn{{\varepsilon_{{\bf k}n}}}
\def\phidot{\dot{\phi}}
\def\phidottilde{\dot{\tilde{\phi}}}
\def\phitilde{\tilde{{\phi}}}
\def\epsilonaone{\epsilon^{(1)}_a}
\def\epsilonatwo{\epsilon^{(2)}_a}
\def\ei{\varepsilon_i}
\def\eis{\varepsilon_{i\sigma}}
\def\ej{\varepsilon_j}
\def\Ekn{{E_{{\bf k}n}}}
\def\Psikn{\Psi_{{\bf k}n}}
\def\Psiqn{{\Psi_{{\bf q}n}}}
\def\Psiqm{{\Psi_{{\bf q}m}}}
\def\DVo{{\it \Delta}V(\omega)}
\def\DVoret{{\it \Delta}V^R(\omega)}
\def\DVoadv{{\it \Delta}V^A(\omega)}
\def\DV{{\it \Delta}V}
\def\DVhat{{\it \Delta}\hat{V}}
\def\HLDA{H^{\rm LDA}}
\def\H0{H^0}
\def\hH{\hat{H}}
\def\veff{V^{\rm eff}}
\def\vxc{V^{\rm xc}}
\def\vc{V^{\rm c}}
\def\vext{V^{\rm ext}}
\def\hVext{\hat{V}^{\rm ext}}
\def\hVeff{\hat{V}^{\rm eff}}
\def\hvnl{\hat{V}^{\rm nl}}
\def\vnl{V^{\rm nl}}
\def\vh{V^{\rm H}}
\def\vgw{V^{GW}}
\def\ReDVo{ {\rm Re}[{\it \Delta}V(\omega)] }
\def\ImDVo{ {\rm Im}[{\it \Delta}V(\omega)] }
\def\gwa{$GW$\!A}
\def\hVee{\hat{V}^{\rm ee}}
\def\hVext{\hat{V}^{\rm ext}}
\def\hHk{\hat{H}^{\rm k}}
\def\Sigmax{{\Sigma}^{\rm x}}
\def\Sigmac{{\Sigma}^{\rm c}}
\newcommand{\req}[1]{\mbox{Eq.~\!(\ref{#1})}}
\newcommand{\refsec}[1]{\mbox{Sec.~\!\ref{#1}}}
\def\Heff{\hat{H}^{\rm eff}}
\def\vbar{\bar{V}}
\newcommand{\hHzero}{\hat{H}^{0}}


\def\Sbarc{\bar{\Sigma}^{\rm c}}

\def\scgw{{QS{\em GW}}}
\def\ldagw{{lda{\em GW}}}
%\def\GLDA{{G^{\rm LDA}}}
%\def\WLDA{{W^{\rm LDA}}}
\def\ekn{{\varepsilon_{{\bf k}n}}}
\def\ekm{{\varepsilon_{{\bf k}m}}}
\def\eknp{{\varepsilon_{{\bf k}n'}}}
\def\Ekn{{E_{{\bf k}n}}}
\def\Psikn{{\Psi_{{\bf k}n}}}
\def\Psikm{{\Psi_{{\bf k}m}}}
\def\Psikmstar{{ \Psi_{{\bf k}m}^*} }
\def\Psiknp{{\Psi_{{\bf k}n'}}}
%\def\rs{r_{\rm s}}

\newcommand{\CikL}{{C^{(i)}_{kL}}}
\newcommand{\CiRkL}{{C^{(i)}_{{\bf R}kL}}}
\newcommand{\tPkL}{{\widetilde{P}_{kL}}}
\newcommand{\tPRkL}{{\widetilde{P}_{{\bf R}kL}}}
\newcommand{\PkL}{{P_{kL}}}
\newcommand{\PRkL}{{P_{{\bf R}kL}}}
%\newcommand{\rmt}{{r_{MT}}}
\newcommand{\rmt}{{s_{\bf R}}}

\def\brl{{\bf R}L}
\def\brlp{{{\bf R}'L'}}
%\def\brl{{\bf a}L}
%\def\brlp{{{\bf a}'L'}}

\def\tili{{\widetilde{i}}}
\def\tilj{{\widetilde{j}}}
\def\tiln{{\widetilde{n}}}
\def\tilm{{\widetilde{m}}}
\newcommand{\val}{{\rm{VAL}}}
\newcommand{\core}{{\rm{CORE}}}
\newcommand{\xc}{_{\rm{xc}}}

\newcommand{\CORE}{{CORE}}
\newcommand{\COREone}{{CORE1}}
\newcommand{\COREtwo}{{CORE2}}
\newcommand{\VAL}{{\rm{VAL}}}
\newcommand{\EF}{E_{\rm F}}
\newcommand{\oneshotgw}{1shot-$GW$}


\def\eak{\varepsilon_{\rm a}(\bfk)}
\def\ebk{\varepsilon_{\rm b}(\bfk)}
\def\iDelta{{\it \Delta}}
\def\efermi{\mbox{$E_{\rm F}$}}

\def\connect#1{\leavevmode{\setbox1=\hbox{#1}\copy1%
\raise .2\ht1 \vbox{\moveleft \wd1\vbox{\hrule width \wd1 height .5pt depth 0pt}}%
}}
%\def\we{\connect{\mbox{$\omega\varepsilon$}}}
\def\we{\mbox{$\omega_\varepsilon$}}
\def\eal{\varepsilon_{al}}
\def\eallo{\varepsilon^{\rm Lo}_{al}}
\def\smh{smHankel}
\def\smhs{smHankels}
\def\shotone{OneShot}
\def\shotonez{OneShot Z=1}
\def\x{\mbox{$\times$}}

\def\xccut{ {\rm xccut} }
\def\xccutone{ {\rm xccut1} }
\def\xccuttwo{ {\rm xccut2} }


\def\ftn[#1]{\rlap{\footnotemark[#1]}}

\def\tr{{\rm Tr}}

\def\bQP{{\it bare QP}}
\def\bQPs{{\it bare QPs}}
\def\dQP{{\it dressed QP}}
\def\dQPs{{\it dressed QPs}}
\def\Re{{\rm Re}}

%\def\pmdelta{\pm i\delta}
%\def\pmdelta{i \mbox{\cal sign}(\efermi -\ei) \delta}

\def\EMAX{  E^{\rm APW}_{\rm MAX} }
\def\EMAXm{ E^{\rm rmesh}_{\rm MAX} }
\def\NAPW{N_{\rm APW}}
\def\RSM{R_{\rm SM}}
\def\RSMa{R_{{\rm SM},a}}
\def\RSMal{R_{{\rm SM},al}}
\def\epsilonal{\epsilon_{al}}
\def\RGS{R_{\rm G}}
\def\RGSa{R_{{\rm G},a}}
\def\pakl{p_{akl}}
\def\PakL{P_{akL}}
\def\wPakL{\widetilde{P}_{akL}}
\def\CakL{C_{akL}}
\def\CiakL{C^i_{akL}}

\def\EMAX{  E^{\rm APW}_{\rm MAX} }
\def\EMAXm{ E^{\rm rmesh}_{\rm MAX} }

\def\nc{n^{\rm c}}
\def\nzc{n^{\rm Zc}}
\def\nzcv{n^{\rm Zcv}}
\def\barnzcv{\bar{n}^{\rm Zcv}}
\def\MM{{\cal M}}
%\def\RR{v}
\def\RR{w}
\def\inta{\int_{|\bfr|\leq R_a}\!\!\!\!\!\!\!\!\!\!\!\!}
\def\intaa{\int_{|\bfr|\leq R_a}}
\def\intad{\int_{|\bfr'|\leq R_a}\!\!\!\!\!\!\!\!\!\!\!\!}
\def\intar{\int_{|\bfr-\bfR_a|\leq R_a}}
\def\intard{\int_{|\bfr'-\bfR_a|\leq R_a}}
\def\rhoij{\rho_{ij}}
\def\ekcore{E_{\rm k}^{\rm core}}
\def\ek{E_{\rm k}}
\def\ehf{E_{\rm Harris}}
\def\nin{n^{\rm in}}
\def\nout{n^{\rm out}}
%\def\Vin{V^{\rm in}}
\def\Vin{V}
\def\iDelta{{\it \Delta}}
\def\philo{{\phi}^{\rm Lo}_{al}}
\def\DEe{{\it \Delta} E_{\rm e}}


\def\ekn{{\varepsilon_{{\bf k}n}}}
\def\ekm{{\varepsilon_{{\bf k}m}}}
\def\eknp{{\varepsilon_{{\bf k}n'}}}
\def\Ekn{{E_{{\bf k}n}}}
\def\Psiqkm{{\Psi_{{\bf q}-{\bf k}m}}}
\def\Psikn{{\Psi_{{\bf k}n}}}
\def\Psikm{{\Psi_{{\bf k}m}}}
\def\Psikmstar{{ \Psi_{{\bf k}m}^*} }
\def\Psiknp{{\Psi_{{\bf k}n'}}}
\def\Psiqnp{{\Psi_{{\bf q}n'}}}
\def\Psiqn{{\Psi_{{\bf q}n}}}
%\def\rs{r_{\rm s}}
\def\brl{{\bf R}L}
\def\brlp{{{\bf R}'L'}}
%\def\brl{{\bf a}L}
%\def\brlp{{{\bf a}'L'}}
\def\tili{{\widetilde{i}}}
\def\tilj{{\widetilde{j}}}
\def\tiln{{\widetilde{n}}}
\def\tilm{{\widetilde{m}}}
\def\eak{\varepsilon_{\rm a}(\bfk)}
\def\ebk{\varepsilon_{\rm b}(\bfk)}
\def\iDelta{{\it \Delta}}
\def\efermi{\mbox{$E_{\rm F}$}}
\def\connect#1{\leavevmode{\setbox1=\hbox{#1}\copy1%
\raise .2\ht1 \vbox{\moveleft \wd1\vbox{\hrule width \wd1 height .5pt depth 0pt}}%
}}
%\def\we{\connect{\mbox{$\omega\varepsilon$}}}
\def\we{\mbox{$\omega_\varepsilon$}}
\def\eal{\varepsilon_{al}}
\def\eallo{\varepsilon^{\rm Lo}_{al}}
\def\smh{smHankel}
\def\smhs{smHankels}
\def\shotone{OneShot}
\def\shotonez{OneShot Z=1}
\def\x{\mbox{$\times$}}
\def\xccut{ {\rm xccut} }
\def\xccutone{ {\rm xccut1} }
\def\xccuttwo{ {\rm xccut2} }
\def\ftn[#1]{\rlap{\footnotemark[#1]}}
\def\tr{{\rm Tr}}
\def\bQP{{\it bare QP}}
\def\bQPs{{\it bare QPs}}
\def\dQP{{\it dressed QP}}
\def\dQPs{{\it dressed QPs}}
\def\Re{{\rm Re}}
%\def\pmdelta{\pm i\delta}
%\def\pmdelta{i \mbox{\cal sign}(\efermi -\ei) \delta}
\def\EMAX{  E^{\rm APW}_{\rm MAX} }
\def\EMAXm{ E^{\rm rmesh}_{\rm MAX} }
\def\EMAXS{E_{\rm MAX}^\Sigma}
\def\NAPW{N_{\rm APW}}
\def\RSM{R_{\rm SM}}
\def\RSMa{R_{{\rm SM},a}}
\def\RSMal{R_{{\rm SM},al}}
\def\epsilonal{\epsilon_{al}}
\def\RGS{R_{\rm G}}
\def\RGSa{R_{{\rm G},a}}
\def\pakl{p_{akl}}
\def\PakL{P_{akL}}
\def\wPakL{\widetilde{P}_{akL}}
\def\CakL{C_{akL}}
\def\CiakL{C^i_{akL}}
\def\EMAX{  E^{\rm APW}_{\rm MAX} }
\def\EMAXm{ E^{\rm rmesh}_{\rm MAX} }
\def\EMAXvxc{ E^{\rm vxc}_{\rm MAX} }
\def\nc{n^{\rm c}}
\def\nzc{n^{\rm Zc}}
\def\nzcv{n^{\rm Zcv}}
\def\barnzcv{\bar{n}^{\rm Zcv}}
\def\MM{{\cal M}}
\def\RR{v}
\def\inta{\int_{|\bfr|\leq R_a}\!\!\!\!\!\!\!\!\!\!\!\!}
\def\intaa{\int_{|\bfr|\leq R_a}}
\def\intad{\int_{|\bfr'|\leq R_a}\!\!\!\!\!\!\!\!\!\!\!\!}
\def\intar{\int_{|\bfr-\bfR_a|\leq R_a}}
\def\intard{\int_{|\bfr'-\bfR_a|\leq R_a}}
\def\rhoij{\rho_{ij}}
\def\ekcore{E_{\rm k}^{\rm core}}
\def\ek{E_{\rm k}}
\def\ehf{E_{\rm Harris}}
\def\nin{n^{\rm in}}
\def\nout{n^{\rm out}}
%\def\Vin{V^{\rm in}}
\def\Vin{V}
\def\iDelta{{\it \Delta}}
\def\philo{{\phi}^{\rm Lo}_{al}}
\def\DEe{{\it \Delta} E_{\rm e}}
\def\ERPA{E^{\rm RPA}}
\def\bfp{\bf p}
\def\EMAX{  E^{\rm APW}_{\rm MAX} }
\def\H0{H^0}
\def\hHZ{\hat{H}^0}
\def\hH{\hat{H}}

\def\QSGW{QS{GW}}

\def\Psikn{{\Psi_{{\bf k}n}}}
\def\Psikm{{\Psi_{{\bf k}m}}}
\def\Psikmstar{{ \Psi_{{\bf k}m}^*} }
\def\Psiknp{{\Psi_{{\bf k}n'}}}
\def\Psikqn{{\Psi_{{\bf k}+{\bf q} n}}}
\def\Psikm{{\Psi_{{\bf k}m}}}
\def\Psikmstar{{ \Psi_{{\bf k}m}^*} }
\def\Psiknp{{\Psi_{{\bf k}n'}}}

\newcommand{\incg}[1]{\includegraphics[width=5.9cm]{#1}}
\newcommand{\template}{
&      & $r_{\rm e}$/\AA      & $D_e$/(Kcal/mol) & $\omega_e$/(cm$^{-1}$)\\
& $R_a$/\AA & for $\EMAX$Ry$\!=\!2,3,4$ & for $\EMAX/$Ry$\!=\!2,3,4$ & for $\EMAX/$Ry$\!=\!2,3,4$  \\
}

\newcommand{\incgg}[1]{\includegraphics[width=8.5cm]{#1}}

\bibliographystyle{apsrev4-1}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
\special{papersize=8.5 in, 11 in}
\title{ecalj package: (based on pmttheoty17.tex:
Formulation of the augmented plane-wave and muffin-tin orbital method)
(この文書はメモです.英語バージョンが基本ですが,開発については,
すこしだけ有用なメモも含まれます)}
\author{Takao Kotani}
\affiliation{Department of applied mathematics and physics, Tottori university, Tottori 680-8552, Japan}
\date{\today}

\begin{abstract}
{\bf NOTE: This document is for one-body problem part}.
``ecalj package''は、おもにはPMT法およびそれを元にしたQSGW法（PMT-QSGW法） 
を実行するためのコードである。PMT法はAPWとMTOを同時に使う
混合基底の第一原理計算の方法である。周期境界条件を用いる。
GGA（PBE）のレベルで原子に働く力を求めての構造緩和なども可能である.
一体問題を解く部分をlmf,QSGWを解く部分をfpgwと呼ぶ。この文書ではlmfパートのみについて述べる。\\

A mixed basis all-electron full-potential method, 
which uses two kinds of augmented waves, the augmented plane waves  
and the muffin-tin orbitals simultaneously, in addition to the
local orbitals, was proposed by Kotani and van Schilfgaarde in Phys. Rev. B81, 125117(2010). 
In this paper, this mixed basis method is reformulated on the basis of a new
formalism named as the 3-component formalism, which is a
mathematically transparent version of the additive
augmentation originally due to Soler and Williams in Phys. Rev. B47, 6784(1993). 
Atomic forces are easily derived systematically. 
We discuss some problems in the mixed basis method and ways to
manage them. In addition, we 
compare the method with the PAW method on the same footing. 
\end{abstract}
\pacs{71.15.Ap, 71.15.-m, 31.15.-p}
\maketitle

% --------------- Introduction ------------------
\section{introduction}
In the first-principle electronic structure calculations based on the
density functional theory in the LDA/GGA
(local density approximation/generalized gradient approximation),
a key element is the one-body problem solver, which 
should have efficiency, accuracy and robustness.
%Even in methods to go beyond DFT such as the quasiparticle
%self-consistent $GW$ (QSGW) \cite{kotani07a}, the solver is a key
%to obtain accurate results with minimum computational efforts.
As such solvers, the linearized augmented plane wave (LAPW) method and the 
linearized muffin-tin orbital (LMTO) method were proposed by Andersen
in 1975 \cite{Andersen75}, followed by many improvements
and extensions \cite{rmartinbook,Singhbook,bluegel31,lmfchap,PAW,PhysRevB.43.6388}.
Today LAPW and LMTO has developed to be full-potential methods, 
which we treat in this paper.
In these methods, wavefunctions are represented by superpositions of
augmented waves used as a basis. The LAPW uses the augmented plane waves (APWs) made 
of plane waves (PWs) as envelope functions. 
The LMTO uses the muffin-tin orbitals (MTOs) made of the atom-centered 
Hankel functions. Corresponding to these envelope functions, the APWs fit to
the extended nature of wavefunctions; 
in contrast, the MTOs to the localized nature of them.
However, wavefunctions in real materials should have both the natures.

This fact is reflected as shortcomings in these methods.
In the case of the LAPW, it requires too many bases 
in order to represent sharp structures of wavefunctions 
just outside of muffin-tins. For example, 3$d$ orbitals of transition
metals are the typical cases. Most of all the PWs used in the LAPW method 
are consumed only to reproduce the sharp structures.
On the other hand, the LMTO is problematic in representing 
the extended nature of wavefunctions. For example, we sometimes need to 
put empty spheres between atoms. In addition, it is not 
simple to enlarge basis set systematically 
in order to check numerical convergence.

To overcome these shortcomings, 
Kotani and van Schilfgaarde introduced a new linearized method 
named as the APW and MTO method (the PMT method) \cite{pmt1}, which is an all-electron (AE) 
full-potential mixed basis method using APWs and MTOs simultaneously.
Because these two kinds of basis are complementary, 
we can overcome these shortcomings. Within our knowledge, 
no other mixed basis methods have used different kinds 
of augmented waves simultaneously in the full-potential methods.

A minimum description on the formalism of the PMT method is given in Ref.\cite{pmt1}, 
which is based on Ref.\cite{lmfchap} for a LMTO method  
by Methfessel et al. However, the formalism was not very transparent, 
mainly because it was not derived from the explicit total energy minimization.
This makes theoretical treatment of the PMT method somehow complicated.
For example, it resulted in a complicated logic to derive atomic forces 
in Refs.\cite{molforce,lmfchap}. 
%Since we are afraid of
%the Pulay terms \cite{pulay69}, it should be derived from the derivative
%of total energy. 
It was not easy to compare the PMT method with the projector augmented
wave (PAW) methods \cite{PAW,kresse99} on the same footing.
Thus we should give a simple and clear formalism to the PMT method 
for its further developments rather than that in Refs.\cite{pmt1,lmfchap}.

In this paper, we introduce a formalism, named as the 3-component
formalism, which is a mathematically transparent generalization of the additive
augmentation given by Soler and Williams \cite{soler89,soler90,soler93} 
(See discussion in Sec.VII in Ref.\cite{PAW}).
We give a formalism of the PMT method based on the 3-component formalism.
In the PAW method \cite{PAW}, the total energy is minimized as a
functional of pseudo wavefunctions. In the 3-component formalism,
the minimization is formulated as for the wavefunctions represented in the 
{\it 3-component space} defined in \refsec{sec:formalism} under some constraints.
This is somehow general in the sense that it allows to use any kinds of basis 
(need not to be given by projectors); thus it is
suitable to formulate mixed basis methods such as the PMT.
Results of the PMT method applied to diatomic molecules from H$_2$ through Kr$_2$ 
are given in elsewhere \cite{kotani_linearized_2013}. Considering the fact
that the PMT method (even the LMTO itself) is already pretty good to
describe solids \cite{pmt1,lmfchap,kotani07a,mark06adeq},
the PMT method can be a candidate to perform full-potential
calculations for molecules and solids in an unified manner, 
more efficiently than LAPW.

In Sec.\ref{sec:formalism}, we will give the 3-component formalism.
Functional relations of physical quantities become transparent in the formalism.
In Sec.\ref{sec:pmtmethod}, we give the formulation of the PMT method
based on the 3-component formalism. Then we discuss problems
in the PMT method and ways to overcome them, giving a comparison with the PAW method.
Derivation of atomic forces becomes straightforward as given in Appendix
without any confusion that were discussed in Ref.\cite{soler93}.



\section{PMT法の基本の考え方}
（スキップしてよい）。

PMT法の母体はFP-LMTOのパッケージ（lmf package）から進化させたものである。
その母体であるlmfの主文献は二つあり、\cite{lmfchap}と\cite{nfpmanual}で
ある。これらは、/MarksOriginalDoc/nfp-doc.ps.gzと
/MarksOriginalDoc/nfp-manual.ps.gz
に格納されている。PMT法の基本アイデアを記述した文献は\cite{pmt1}である。
エッセンスだけがかかれているので詳細はすこし分かりにくい。

PMT法は以下の考えに基づいている。
\begin{itemize}
\item[(1)]
3成分表示での取扱い(Soler-Williams形式)：\\
基底関数,電子密度、一体ポテンシャル（そしてKSハミルトニアン）を、
「smooth part　+　onsite part」に分割して
取り扱う手法である。ここで、oniste part =``true part'' - ``counter part''
であり、Muffin-tin(MT)内でのみ値をもつ。
couter part は、smooth partのMT内成分を打ち消す成分である.
smooth partは全空間に広がっており,
onsite成分は原子のサイト(MTサイト)内でのみ値をもつ成分である。
大雑把に言えば、「smooth part　+　true part　- counter part」
の3成分によって表現すると言ってもよい。これを3成分表示の理論形式として
与えることができる。形式論としては、MT半径を重なるようにとっても数学的な破綻は生じない.
また、物理量を計算するときに、これらの3成分の間のクロスタームを
用いないで計算することになる。原子に働く力などもきれいなformalismで計算できる。
このアイデアは現代の線形化法におけるスタンダードのひとつであり、もとは
\cite{soler89}などで与えれている（このときはLAPW法をベー
スに議論している）。PAW法（\cite{PAW},\cite{kresse99}）も同じアイデアにもとづいている。

基底関数がなんらかの形で与えれている(たとえば以下の(2),(3)のよう
に)とすれば、波動関数は、それの線形結合で書かれることになる。全エネルギー
は、（占有された）波動関数が与えられれば決定される。解くべき問題は、
その線形結合の係数をうまく選んでその全エネルギーを波動関数の直交性のもとで最小化することである。

%この分割には不定性がある（たとえば、電子密度に関して
%smooth partとcounterパートに同時に同じだけつけくわえても、
%物理的には同じ電子密度をあらわすはずである）.
%これを利用して静電エネルギーなどはうまく定義することができる。

%この方法では一体ハミルトニアンにおいて、低い$l$チャンネル
%に関してのみaugmentすることになる。高い$l$成分はaugmentされずにMT内に存
%在していることになる。ただし、

\item[(2)]
基底関数を構成するため、envelope関数として何をもちいるか？：\\
基底関数を用意するには、まずはenvelope関数を用意しそれを何らかの方法で
augmentする。PMT法においては、smooth Hankel関数（従来のFP-LMTOにお
けるenvelope関数）とPlane wave(LAPWで用いられる平面波)の二種をもちいる。
これらをaugmentすることでMTOとAPWが得られる。
固体中において、「平面波的な波動関数（s,p電子など）」と「局在性の高い電
子(d,f電子など)」が共存することを考えると自然な方法であるといえる。
実際、効率の高い方法となる。

\item[(3)]
Augmentation:どうやってenvelop関数から基底関数をつくるか？：\\
Augmentationでは、a.どうやってenvelope関数からcounter partを作るか？
b.切り取った代わりになにを付加するか？の二点が問題となる。PMT法とPAW法の
おもな違いはこの点にあるといえる。

a.PMT法では、smooth Hankel関数の中心のMTにある部分(head part)に関しては,
smooth Hankel関数をそのままcounter partとして用いる。
また、その中心でないMTにある部分(tail part)については、
「ラゲール関数$\times$Gaussianの関数系」で展開し、counter partを作っている。
APW平面波については、このtail partと同様の関数系でそのMT内成分を展開している。

b.基本的には、従来のLAPWにおけるtraditionalなaugmentationの仕方を
もちいる。すなわち、envelope関数に対して、$\phi,\phidot$(各$l$ごとに適当なエネ
ルギー(通常は占有バンド重心位置)で解いた原子基底)を
もちいてMT端での値と微分値が一致するようにaugmentする。


また、セミコア基底関数を、local orbital(MT内に局所化する）として取り込むことも
できるようになっている。これはしばしば必要となる。

\end{itemize}

KresseのPAWの文献\cite{kresse99}は、ノーテーションが煩雑だがまとまりはいい。
その記述の多くの部分は、(1)に関係しており、その点ではlmfと共通である.
また、一般論として読むなら、lmfの文献\cite{lmfchap}は、
わかりにくい点もある(とくに、Forceをどうやって求めて
るのか？でMethfessel and van Schilfgaardeの文献(\cite{molforce})
が引用されてるが,かなりわかりにくい）。

PAW法とPMT法ではエネルギー汎関数の形や表現法はほとんど同じであり、
用いる基底関数の作成法が違っているだけである。


%%%%%% --------------- PMT formalism ------------------
\section{3-components formalism}
\label{sec:formalism}
まず「3-component formalism」(Soler-Williams形式を書き直したもの)につい
て説明する。これは一般的なaugmentationの方法である。
これは一般的に通用する形式論である。たとえばVASPでも基本的に類似の形式を用いている。

一般的なLAPW法と同様に、周期境界条件を考える。
実空間（もしくは実空間におけるユニットセル）を$\Omega$であらわす。
$\Omega$はMTregionとその外側のinterstitial regionに分かれる。
MTは原則的には重なっているべきではない（しかしながら、以下のformalismでは
MTが重なっていても数学的破綻はなく、DFT計算においてはいくらかの重なりがあっ
ても、それほどおかしくない全エネルギーの値が得ることはできる）。
MT半径は$R_a$でその中心は、$\bfR_a$にあるとする。ここで$a$は$\Omega$内のMTを指定するindexである。
角運動量のindexにはcombined angular momentum index
$L\equiv(l,m)$をもちいる。ここで $l$ と $m$ はそれぞれ、orbital と magnetic quantum
numbersである。また$\hbar=1$, electron mass $m_e$, and electron charge
$e$を用いる。以下では、スピン変数については簡単のため省略して、formalism
を書き下す（適宜おぎなって読んでいく必要がある）。

「3-component formalism」では基底関数を
スムーズパート、MT内成分、MT内でスムーズパートを打ち消す成分にわけて表現する。
またaugmentationは実際には「基底関数そのものにではなく、その積に適用する」
ということを行っており、それらの3成分を実際に加減算するというような演算は行わない。
%またlocal orbital\cite{PhysRevB.43.6388}も含むことができる。

We assume periodic boundary condition where
real space (or unit cell) is specified by $\Omega$.
$\Omega$ is divided into the muffin-tin (MT) regions and the interstitial region.
The MTs are located at $\bfR_a$ with radius $R_a$, where 
$a$ is the index specifying a MT within $\Omega$.
$L\equiv(l,m)$ is the angular momentum index.
We use units, $\hbar=1$, electron mass $m_e$, and electron charge $e$. 
The spin index is not shown for simplicity.

Here we give the 3-component formalism as a general
scheme for the augmented-wave methods, which include any kinds of
augmented waves including the local orbitals \cite{PhysRevB.43.6388}.
%The 3-component formalism is given from the point of view that 
%how to model the quantum mechanics in the 3-component space as follows.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\subsection{the 3-component space(日本語での予備的説明)}
\label{sec:3compoj}
（スキップして\refsec{sec:3compo}から読むこともできる）。

最初に全空間をMuffin-Tin(MT)領域と外部領域に分割する。
エンベロープ関数を用意して、それをaugmentすることで、「基底関数」をくみ
たてる。おおまかにいえば、MT内部でのみエンベロープ関数をさしかえるということである。
envelope関数として、PMT方法では「（LAPWでもちいられる）平面波」と、
「（LMTOでもちいられる）smooth Hankel関数」を同時に用いる．
envelope関数はまとめて$\{{F}_{0i}(\bfr)\}$で表す。ここで$i$は、envelope関数を指定するindexである。
「基底関数(augmented wave)」 $\{{F}_i(\bfr)\}$は、
envelope関数$\{F_{0i}(\bfr)\}$を用いて以下のように書かれる。　　
\begin{equation}
F_i(\bfr) = F_{0i}(\bfr) + F_{1i}(\bfr)-F_{2i}(\bfr) \label{eq:basis} \\
\end{equation}
ただし、
\begin{eqnarray}
&&F_{1i}(\bfr)=\sum_a F_{1ia}(\bfr-\bfR_a)= \sum_{akL} C^{i}_{akL} \tilde{P}_{akL}(\bfr-\bfR_a) \\ 
&&F_{2i}(\bfr)=\sum_a F_{2ia}(\bfr-\bfR_a)= \sum_{akL} C^{i}_{akL} {P}_{akL}(\bfr-\bfR_a)  
\end{eqnarray}
である（これは、文献\cite{lmfchap}の式19である）。$a$はatomic sites
index. $L=(l,m)$.$F_{1ia}(\bfr),F_{2ia}(\bfr),P_{akL} (\bfr),\tilde{P}_{akL} (\bfr)$ は 
$|\bfr| \le R_a$で定義されている。ここで$R_a$はMTサイト$a$の半径。
 
%これはMTをつかう方法における標準的な波動関数の表式である;
この\req{eq:basis}は、PAWでもLAPWでもLMTOでも同じであり、MTをつかう方法における波
動関数の一般的な表式である.このノーテーションでは、\req{eq:basis}のよう
に基底関数$F_i$は、$F_{0i}$,$F_{1i}$,$F_{2i}$の成分からなっており、それぞれを
第0,1,2成分と呼ぶ。で、「index $i$で指定される基底関数の第0成分をenvelope関数と呼ぶ」と取り決
めたことになる.
%$i$番目のenvelope関数は$F_{0i}(\bfr)$であらわす。この

$F_{0i}(\bfr)$のMTサイトでの成分が$F_{2i}(\bfr)$である
（「各MTサイトにおいて適当な関数系$\{{P}_{akL}(\bfr)\}$を用いて
$F_{0i}(\bfr)$を展開したもの」をすべてのサイトについて加え合わせたもの）。

それゆえ、$F_{0i}(\bfr)+F_{1i}(\bfr)-F_{2i}(\bfr)$は、
$F_{0i}(\bfr)$からMTサイトでの寄与をくり抜いたうえで
$F_{1i}(\bfr)$をつけくわえたものとなっている。
ここで、$F_{1i}(\bfr)$において用いられている
${P}_{akL}(\bfr)$は、各サイトでのradial schoredinger eq.の解
$\phi,\phidot$の線形結合であり、MT端において、値と微分値が
$\tilde{P}_{akL}(\bfr)$と一致している.すなわち、
\req{eq:basis}は、$F_{0i}(\bfr)$
を各MTサイト内においてのみ修正をほどこしたものであり、
「Envelope関数$F_{0i}(\bfr)$をaugmentして基底関数$F_i(\bfr)$が得られた」ことになる。

%それの第0成分である$F_{0i}(\bfr)$がもとになるenvelope関数である。
$F_{1i}(\bfr)$,$F_{2i}(\bfr)$は$F_i(\bfr)$の第１、第２成分であり、
augmentationに関連した成分である；これらは各原子サイト$a$からの寄与の
総和であり、$F_{1i}(\bfr)=\sum_a F_{1ia}(\bfr-\bfR_a)$などと書いたりもし
てする。うえの式と見比べ
ると、$F_{1ia}(\bfr)=\sum_{kL} C^{i}_{akL} \tilde{P}_{akL}(\bfr)$
である（indexの付け方に注意すること）。
%$F_{2i}(\bfr)$は$F_{0i}(\bfr)$のMTへのプロジェクションであり（$F_i(\bfr)$を
%MT領域で切り取ったもの）、線形なprojection演算子${\cal P}_2$で、$F_{2i}={\cal
%P}_2F_{0i}$などと書くことも可能である。
このプロジェクションは完全な切り取りにはなってなくて、$L$と$k$の範囲が限
定的である($l\le$LMXA, $k\le$KMXA.$k$は動径方向の自由度のindex)。
すなわち、$F_{0i}(\bfr)$を、各MTサイトで有限個の${P}_{akL} (\bfr)$で展
開し切り取っている。それらを$\tilde{P}_{akL}(\bfr)$で差し替えている。
どうしても展開の不完全さはのこるので、$F_{2i}$は$F_{0i}$を完全なMT内での
成分というわけにはいかない点はある。数値計算の上では、そのことが、計算の
不安定性を引き起こさないようにしないといけない。

ただ現実には、
$F_{0i}(\bfr)+F_{1i}(\bfr)-F_{2i}(\bfr)$などという加減演算はコードの中で
行う訳ではない。これを考えると、基底関数$F_{i}(\bfr)$はむしろ、「これら
の関数の一揃い(集合）」であるとして考えた方がいい。これを以下説明する。

\subsection{the 3-component space}
\label{sec:3compo}
Any augmented basis $F_{i}(\bfr)$ consists of three kinds of components, 
where $i$ is the index specifying basis function. $F_{i}(\bfr)$
consists of the following three components:
\begin{itemize}
\item[(0)] 
the smooth part (= envelope function) $F_{0i}(\bfr)$
\item[(1)]
the true parts $F_{1i,a}(\bfr)$ defined in MTs $|\bfr| \leq R_a$.
\item[(2)]
the counter parts $F_{2i,a}(\bfr)$ defined in MTs $|\bfr| \leq R_a$ 
(canceling the smooth parts within MTs).
\end{itemize}
We call $F_{0i}(\bfr)$, $F_{01,a}(\bfr)$, and $F_{02,a}(\bfr)$ as the
0th, 1st, and 2nd components of $F_{i}(\bfr)$, respectively.
The $F_{0i}(\bfr)$ should be an analytic function in space or a linear
combination of analytic functions.
In the PMT method, $F_{0i}(\bfr)$ are the PWs or the Bloch sums of the
Hankel functions; exactly speaking, we use atom-centered 
smooth Hankel functions (\smhs) instead of the conventional Hankel functions, 
so as to avoid divergence at its center 
\cite{lmfchap,Bott98} (See \req{eq:defh0} and around). 
$F_{1i,a}(\bfr)$ and $F_{2i,a}(\bfr)$ are defined only at
$|\bfr| \leq R_a$ (in cases below, we sometimes take these are zero at $|\bfr|>R_a$).
In the sense that $F_{0i}(\bfr)$ is analytic and 1st and 2nd components 
are given on a dense radial mesh, a basis $F_{i}(\bfr)$ is specified
without any numerical inaccuracy.

従来のaugmentationの理論においては、これらを用いて基底関数は
$F_i(\bfr) = F_{0i}(\bfr)+\sum_a F_{1i,a}(\bfr-\bfR_a)- \sum_a F_{2i,a}(\bfr-\bfR_a)$ 
(e.g. See Eq.(2) in \cite{kresse99})と書くことができる。
しかしながら,以下の方法では、この表式は形式的なものであり、各コンポーネントは
それぞれ個別に処理され、コンポーネントをつなぐような項は現れ得ない。
これを考えると、基底関数$F_i$を「関数の集合」であると考えたほうが
自然であり、$F_i=\{F_{0i}(\bfr),\{F_{1i,a}(\bfr)\},\{F_{2i,a}(\bfr)\} \}$
という表式を用いて理論をもちいて書き下したほうが、
より正確に理論が表現でき、以下で見るように数学的に素直で論理構造が明瞭なformalismが組み立てられる。
ただ、上の$F_i$の表式をそのまま使っていくと、はやたらと括弧がやたら多く、
見にくい数式になってしまうので、この式のかわりに以下の\req{eq:basis}を用いることとする。

$F_{i}(\bfr)$ is a member in the {\it 3-component space}, which
is defined as a direct sum of linear spaces
corresponding to the components (0), (1) and (2). Thus $F_i$ can be expressed as
$F_i=\{F_{0i}(\bfr),\{F_{1i,a}(\bfr)\},\{F_{2i,a}(\bfr)\} \}$
(curly bracket mean a set), where $F_{1i}\equiv \{F_{1i,a}(\bfr)\}$
means a set as for the MT index $a$, $F_{2i}$ as well. However, in the followings, we use a
little different expression instead:
\begin{eqnarray}
F_i(\bfr) = F_{0i}(\bfr) \ooplus \{ F_{1i,a}(\bfr)\} \oominus \{F_{2i,a}(\bfr)\}\nonumber\\
= F_{0i}(\bfr) \ooplus F_{1i}(\bfr)\oominus F_{2i}(\bfr).
\label{eq:basis}
\end{eqnarray}
This makes following expressions easy to read without any difference
in their meanings. Symbols $\ooplus$ and $\oominus$ mean nothing more
than separators.
We call a member in the 3-component space as a 3-component function in
the followings.
Wavefunctions are also given as 3-component functions.
With the coefficients $\{\alpha_{p}^i\}$, wavefunctions can be written as
\begin{eqnarray}
\psi_p(\bfr) = \sum_i \alpha_p^i F_i(\bfr),
\label{eq:eig}
\end{eqnarray}
where linear combinations are taken for each components.
We represent electron density and so on as a 3-component function as well.

$\oplus$と$\ominus$は、単なるセパレーターであり、\req{eq:basis}は
上記の本来の表式の$F_i(\bfr)$と全く同じものを意味している。
$F_i(\bfr)$は定義域を$\Omega$とする関数ではなく、
関数の集合を意味している。
この\req{eq:basis}は基底関数に関するものであるが、一般的に言ってこの形式
の表式を3-component functionでの表式と呼ぶことにする。以下では電子密度な
どもこの表式であらわされることになる。
記号 $\oplus$ と $\ominus$ で分離された3つの成分を、
0th, 1st, and 2nd components of $F_i$と呼ぶことにする。
ここで$F_{1i}\equiv\{ F_{1i,a}(\bfr)\}$ と$F_{2i}\equiv\{ F_{2i,a}(\bfr)\}$と
書く。それで1stと2nd componentsは、MT内で定義された関数$F_{1i,a}(\bfr)$な
どの集合である。添字$a$はこの関数が$\bfR_a$にあるMT内で定義された関数で
あることを示している。

我々は、基底関数を3成分関数であるとしたから、この基底関数を
実空間$\Omega$での量と対応させるためには、何らかの写像で、$\Omega$の量と対応させ
る必要がある。この写像として以下の$\calR$-mapping を定義する。
（ただこれは理論的な議論をするために導入するものであって、実際のコードでそういう足し合わせは行わない）。\\
Note that the 3-component space is a mathematical
construction, a model space: we have to specify how to map a 3-component 
function to a function in real space.
For this purpose, we define $\calR$-mapping (augmentation mapping)
from a 3-component function to a function in real space;
\begin{eqnarray}
\calR[\psi_p(\bfr)]\!\equiv\! \psi_{0p}(\bfr)
\!+\! \sum_a \psi_{1p,a}(\bfr\!-\!\bfR_a)\!-\!\sum_a \psi_{2p,a}(\bfr\!-\!\bfR_a). \nonumber \\
\label{eq:calRF}
\end{eqnarray}
This is nothing but a conventional augmentation 
where physically meaningful wavefunctions $\psi_{p}(\bfr)$ 
should satisfy following conditions (A) and (B);
\begin{itemize}
\item[(A)]
Within MTs ($|\bfr|<R_a$), $\psi_{2p,a}(\bfr)=\psi_{0p}(\bfr+\bfR_a)$.
\item[(B)]
At MT boundaries ($|\bfr|=R_a$), $\psi_{1p,a}(\bfr)$ and $\psi_{2p,a}(\bfr)$
should have the same value and slope.
\end{itemize}
If (A) is satisfied, the contribution from $\psi_{0p}$ within MTs 
perfectly cancels those of $\psi_{2p,a}$ in \req{eq:calRF}. 
The total energy in the DFT is given as a functional
of eigenfunctions as $E[\{\psi_{p}(\bfr)\}]$, where
$\{\psi_{p}(\bfr)\}$ are for occupied states.
Our problem is to minimize this under the constraint of
orthogonality of $\psi_{p}(\bfr)$ with conditions 
(A) and (B) on $\{\psi_{p}(\bfr)\}$.
Local orbitals \cite{PhysRevB.43.6388} is also treated as 3-component
functions whose 0th and 2nd components are zero overall.

In the conventional LAPW (e.g. See \cite{bluegel31,Singhbook}),
(A) and (B) are very accurately satisfied. The 2nd component
almost completely satisfy (A) with the use of spherical Bessel functions.
The 1st component are given up to very high $l$ ($\gtrsim 8$). 
Thus the LAPW can be quite accurate. However, it can be 
expensive (we also have null-vector problem. See \refsec{sec:problems}.).

Thus Soler and Williams \cite{soler89} introduced additive augmentation:
to make calculations efficient, we use condition (A') as a 
relaxed version of condition (A),
\begin{itemize}
\item[(A')]
Within MTs ($|\bfr|\leq R_a$), 
$\psi_{2p,a}(\bfr) \approx \psi_{0p}(\bfr+\bfR_a)$.
\end{itemize}
Then we expect high-energy (high frequency) contributions
of eigenfunctions not included in the 1st and 2nd components 
are accounted for by the 0th component. In practice, we can use low $l$ 
cutoff $\lesssim 4$ for both of 1st and 2nd components. 
A LAPW package HiLAPW, developed by Oguchi et al \cite{PhysRevB.54.1159},
implemented a procedure to evaluate physical quantities from 
the basis given by \req{eq:calRF} with the condition (A').

However, it is complicated to evaluate all quasilocal 
products such as the density and kinetic-energy density
from $\calR[F^*_i(\bfr)]\calR[F_j(\bfr')]$,
since it contains cross terms which connect different components.
Thus Soler and Williams \cite{soler89} 
gave a prescription to avoid the evaluation of the cross terms.
With $\calR$-mapping applied not to wavefunctions
but to products of them as in \refsec{aug3},
we have {separable form} of the 
total energy and all other physical quantities 
(no cross terms between components). This is based on the fact that
the total energy in the {separable form} should 
agree with the true total energy only when (A) and (B) are satisfied. 
As we see in the followings, it is a good approximation to use (A') instead of (A). 

Above two important concepts, 
the additive augmentation and the separable form, 
were used in both of LMTO and PAW \cite{lmfchap,PAW,kresse99}.
They were originally introduced in Ref.\cite{soler89}.

与えられた$F_{0i}$に対して、
Augmentationの方法により $F_{1i}$ and $F_{2i}$を、\req{f2}のように定めることができる。
$F_{2i,a}(\bfr)$ は$F_{0i}(\bfr)$のMT内へ射影であり、
以下で述べる展開 \req{onecenter1} において $\CiakL\equiv C_{akL}[F_{0i}]$を用いて
定めることができる。ここで、カットオフを
$l\le l_{{\rm max},a}$と$0\le k\le k_{{\rm max},a}$ とする。すなわち
$F_{2i,a}(\bfr)$はこのカットオフまで含めた意味で与えられる
（MTOの中心サイトの\smh 関数（Head part)は$\{P_{akL}(\bfr)\}$に含まれているとする）。\\
Let us consider how to determine $F_{1i,a},F_{2i,a}$ for
a given $F_{0i}$. As for $F_{2i,a}$, (A') means that 
$F_{0i}$ should be reproduced well within MTs.
Generally speaking, $F_{2i,a}(\bfr)$ can be represented as
\begin{eqnarray}
&&F_{2i,a}(\bfr)\equiv \sum_{k,L} \CiakL P_{akL}(\bfr), \label{f2}
\end{eqnarray}
where $k$ is index for radial degree of freedom. 
We introduce truncation parameters
$k_{{\rm max},a}$ and $l_{{\rm max},a}$; we assume 
sum in \req{f2} is taken for $k\le k_{{\rm max},a}$ and $l \le l_{{\rm max},a}$;
when $k_{{\rm max},a}$ and $l_{{\rm max},a}$ becomes infinite, we assume
condition (A) is satisfied. Even when these truncation
parameters are finite, $F_{2i,a}$ should reproduce
low energy (low frequency) parts of $F_{0i}$ well. 
The functions $\{P_{akL}(\bfr)\}$ can be rather general; 
as explained in \refsec{sec:pmtmethod}
the central parts of \smh\ is treated as it is
(in other words, treated as a member of $\{P_{akL}(\bfr)\}$). %\cite{privatemark1}).
$F_{1i,a}(\bfr)$ is given from \refeq{f2}
with a replacement of ${P}_{akL}(\bfr)$ with $\widetilde{P}_{akL}(\bfr)$.
Here $\widetilde{P}_{akL}(\bfr)$ is a linear combination of
partial waves so as to have the same value and slope with
${P}_{akL}(\bfr)$ at $|\bfr|=R_a$. With this replacement, we have 
\begin{eqnarray}
F_{1i,a}(\bfr) = \sum_{k,L} C^i_{akL} \wPakL(\bfr). \label{f1}
\end{eqnarray}
%We can usually take relatively small $l_{{\rm max},a}$ ($\sim 4$) in practice.
%as discussed in Ref.\cite{soler89}.

$F_{1i,a}(\bfr)$を決めるには,あらかじめ、atomic-like radial functions for
each $al$ を定めておく必要がある。; 我々は、$al$-dependentな
radial functionsを用いる($aL$-dependentなものは用いない。Remind $L\equiv(l,m)$).
これらの関数は、a reference spherical one-body potentials $V_a(r)$ (determined
self-consistently in this paper) と $l$-dependent reference energies
$\eal$から定めることができる。すなわち、我々は、the radial Schr\"odinger
equation を$V_a(r)$ at $\eal$で、解きradial functions $\phi_{al}(r)$
とそのエネルギー微分$\dot{\phi}_{al}(r)$を得ることができる。
また原子によってはloを用いるが、そのときには、
さらに別の関数$\philo(r)$ \cite{eal}をreference energy $\eallo$で解いて用意しておく必要がある。

loについては、$F_{0i}$ と $F_{2i}$ が$\Omega$全領域でゼロである。
それで$F_{1i,a}$はその値と傾きがどちらもMT端でゼロである必要がある。
このloは、規格化を除いて
$\{\phi_{al}(r)Y_L(\hat{\bfr}),\dot{\phi}_{al}(r)Y_L(\hat{\bfr}),\philo(r)Y_L(\hat{\bfr}) \}$
の線型結合で一意的に書くことができる\cite{lo}.

MTOとeloに関しては $F_{1i,a}(\bfr)$ は\refeq{f2}において、
${P}_{akL}(r)$ を $\widetilde{P}_{akL}(r)$ で置き換えることに寄って得ら
れる。ここで、$\widetilde{P}_{akL}$ は
 $\phi_{al}(r)Y_L(\hat{\bfr})$ と$\dot{\phi}_{al}(r)Y_L(\hat{\bfr})$の線
 型結合をとり、MT端で$F_{2i,a}(\bfr)$と値と傾きが一致するようにしたもので
 ある。以上の置き換えで\req{f1}を得る。\\

{\small
\noindent {\bf elo}:(読まなくてよい)
``extended local orbital(elo)``は最近はあまり使ってない。eloはMTOの一
種である。lo同様に、局在性の高いorbitalを表現するために用いられる基底関数
であるが実際上はある種のMTOであり外部に広がりを持っている。
eloはMTOなので、エンベロープ関数\smh を指定する必要がある。それには
$\RSMal$と$\epsilonal$が必要である。これらは、通常のMTOと違い、外部から手
であたえるものではなく、MT端であらかじめ計算された
$\philo(r)Y_L(\hat{\bfr})$と
動径方向の二階微分までスムーズになるように選ばれる。
したがって、elo の$F_{1i,a}(\bfr)$としては、
$\philo(r)Y_L(\hat{\bfr})$そのものを使えば、自動的に（この場合2階微分ま
で）スムーズにそのenvelope関数とつながるものとなっている。
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{augmentation for product of 3-component functions}
\label{aug3} 
電子密度などを評価する際には、その積を問題にする必要があ
る。従来の方法では$\calR[F^*_i]\calR[F_j]$を計算する必要がある。
これは、それぞれが3項からなるので、
$F_{0i}(\bfr) F_{1j}(\bfr)$などのクロスタームを含むことになる。 
このような項を数値的に精度よく評価するのは困難である。
それで、PMT法では,この積の代わりに以下のような積'diagonal product'を考えることになる。\\
Let us give a prescription to evaluate physical quantities
for wavefunctions satisfying conditions (A') and (B).  First, we define
diagonal product of 3-component functions as
\begin{widetext}
\begin{eqnarray}
F^*_i(\bfr)F_{j}(\bfr') &\equiv& F^*_{0i}(\bfr)F_{0j}(\bfr')
\ooplus  \{ F^*_{1i,a}(\bfr) F_{1j,a}(\bfr')\}
\oominus \{ F^*_{2i,a}(\bfr) F_{2j,a}(\bfr')\}, \label{fnproduct}
\end{eqnarray}
where we have no cross terms between different components.
We apply $\calR$-mapping in \req{eq:calRF} to this product as
\begin{eqnarray}
&&\calR[F^*_i(\bfr)F_{j}(\bfr')] = \nonumber \\ 
&&F^*_{0i}(\bfr)F_{0j}(\bfr')
+ \sum_a F^*_{1i,a}(\bfr\!-\!\bfR_a) F_{1j,a}(\bfr'\!-\!\bfR_a)
- \sum_a F^*_{2i,a}(\bfr\!-\!\bfR_a)F_{2j,a}(\bfr'\!-\!\bfR_a). \label{fnmap}
\end{eqnarray}
\end{widetext}
We will use $\calR[F^*_i(\bfr)F_{j}(\bfr')]$ to evaluate quasilocal 
products when (A') is satisfied.
%\req{fnmap} means an augmentation not for the basis itself, 
%but for the product of them.
Since any one-body quantities such as the inner product, electron density,
current and so on, are quasilocal, we can evaluate these from 
$\calR[\psi^*_p(\bfr)\psi_{p'}(\bfr')]$.
Generally speaking, we can evaluate matrix elements of a
quasilocal operator $X(\bfr,\bfr')$ in real space
from 3-component wavefunctions $\psi_p(\bfr)$ in separable form as 
\begin{eqnarray}
\langle \psi_p|X|\psi_{p'} \rangle=\int d^3r d^3r' X(\bfr,\bfr') 
\calR[\psi^*_p(\bfr)\psi_{p'}(\bfr')].
\end{eqnarray}
We can read this as a transformation of $X$ to the corresponding 
operator in the 3-component space.

この$\calR[F^*_i(\bfr)F_{j}(\bfr')]$ が物理的に意味があるのは以
下の二つの場合である。第一の場合は、 $\bfr$と$\bfr'$ のどちらもが、
同一のMT内にある場合である。このとき\req{fnmap}の
$F^*_{1i,a}(\bfr-\bfR_a) F_{1j,a}(\bfr'-\bfR_a)  
-F^*_{2i,a}(\bfr-\bfR_a) F_{2j,a}(\bfr'-\bfR_a)$ は
右辺第一項のenvelope関数の積をatomic-like functionsの積で置き換えている
ことになる。第二の場合は $\bfr$ と $\bfr'$ のどちらもがinterstitial
regionにある場合であり、$\calR[F^*_i(\bfr)F_{j}(\bfr')]$ は
$F^*_{0i}(\bfr)F_{0j}(\bfr')$に一致している。
これらのことから、$\bfr \approx \bfr'$では
$\calR[F^*_i(\bfr)F_{j}(\bfr')]$ を
$\calR[F^*_i(\bfr)]\calR[F_{j}(\bfr')]$ の代わりに、
基底関数の積を表現するのに用いることができることがわかる。
電子密度や運動エネルギー項など、すべての物理量は、波動関数に関して双線型な演算子を
基本にして組み立てられているので、この量の線型結合でそれらを表すことがで
きる。

\subsection{eigenfunction, overlap matrix, and kinetic energy}
\label{sec:eigenfunction}
物理量を評価するための基本的処方箋を与える。
まず、一体波動関数は係数$\{\alpha_{p}^i\}$ をもちいて
\begin{eqnarray}
\psi_p(\bfr) = \sum_i \alpha_p^i F_i(\bfr).
\label{eq:eig}
\end{eqnarray}
と展開できることから出発する。
ここで、この波動関数は3成分表示で表示されている
（3成分表示での和はその成分ごとにとられる）。
次に、\req{fnproduct}の定義にもとづいて、
$\psi^*_p(\bfr)\psi_{p'}(\bfr')$を考える。さらに$\Omega$への写像
\begin{eqnarray}
\calR[\psi^*_p(\bfr)\psi_{p'}(\bfr')]= 
\sum_{i,j} \alpha_{p}^{i*} \alpha_{p'}^j \calR[F^*_i(\bfr) F_j(\bfr')].
\label{eq:phiphi}
\end{eqnarray}
を考える。そして、あらゆる双線形な基礎的物理量は$\bfr \approx \bfr'$で
$\calR[\psi^*_p(\bfr)\psi_{p'}(\bfr')]$から計算することができる。
これで、実空間$\Omega$で定義されている物理量を、
3-component function ${\psi_p}(\bfr)$の汎関数として(基底が固定されているばあには
$\{\alpha_{p}^i\}$の関数として)与えることが可能になる処方箋を与えたことに
なる。

Based on the above prescription, we can define the inner product 
$\langle \psi_p |\psi_{p'} \rangle$ as $\langle \psi_p |\psi_{p'}
\rangle=\sum_{i,j}\alpha_{p}^{i*}\alpha_{p'}^{j}O_{ij}$.
Here the overlap matrix  $O_{ij}$ is:
\begin{widetext}
\begin{eqnarray}
O_{ij} &\equiv& \langle F_i|F_{j} \rangle \equiv \int_\Omega d^3r 
  \calR[F^*_i(\bfr)F_j(\bfr)] \nonumber \\
&=&\int_\Omega d^3r  F^*_{0i}(\bfr)F_{0j}(\bfr)
  + \sum_a \inta d^3r  F^*_{1i,a}(\bfr)F_{1j,a}(\bfr) 
  - \sum_a \inta d^3r  F^*_{2i,a}(\bfr)F_{2j,a}(\bfr).  \label{eq:norm} 
\end{eqnarray}
This can read as a definition of the inner product in the 3-component space.
For a given finite basis set, we can expect that $O_{ij}$ should be
positive definite as long as truncation parameters are large enough.
The kinetic energy is given 
from $\rho_{ij}=\sum_{p}^{\rm occ.} \alpha^{i*}_p \alpha^j_p$ (occ. means
the sum for occupied states) as $\ek=\sum_{i,j} \rho_{ij} T_{ij}$.
Here the kinetic-energy matrix $T_{ij}$ is given as
\begin{eqnarray}
&&T_{ij}\equiv \frac{\langle \nabla F_i| \nabla F_{j} \rangle}{2m_e}
 \equiv \frac{1}{2m_e} \int_\Omega d^3r \left(\nabla_\bfr \nabla_{\bfr'}
 \calR[F^*_i(\bfr)F_j(\bfr')]\right)_{\bfr=\bfr'} 
=\frac{1}{2m_e} \int_\Omega d^3r 
\calR[\nabla F^*_i(\bfr) \nabla F_j(\bfr)] \nonumber \\
&&= \int_\Omega d^3r \frac{\nabla F^*_{0i}(\bfr) \nabla F_{0j}(\bfr)}{2m_e} 
+ \sum_a \inta d^3r \frac{\nabla F^*_{1i,a}(\bfr) \nabla F_{1j,a}(\bfr)}{2m_e}
- \sum_a \inta d^3r \frac{\nabla F^*_{2i,a}(\bfr) \nabla F_{2j,a}(\bfr)}{2m_e}.
\label{eq:kin}
\end{eqnarray}
Partial integration gives $T_{ij}= \langle F_i| \frac{-\nabla^2 }{2m_e}|F_{j} \rangle$, 
since $F_{1i,a}$ and $F_{2i,a}$ have the same value and slope at the MT boundaries.
This kinetic energy operator is interpreted as $T=\frac{-\nabla^2 }{2m_e} \oplus
\{\frac{-\nabla^2 }{2m_e} \} \ominus  \{\frac{-\nabla^2 }{2m_e} \}$ in the 3-component space.

{\small 
\noindent{\bf 重なり積分が正定値になっているか？:}\\
前述の重なり積分は、$F^{*}_{2i}(\bfr) F_{2j}(\bfr)$に関わる部分で負符号
になりうる部分を含んでいる。原則的には、
\begin{eqnarray}
\int dr F^*_{0i}(\bfr) F_{0j}(\bfr)  
+ \sum_a \int_{|\bfr| <R_a} d\bfr ( - F^{*}_{2i}(\bfr) F_{2j}(\bfr)) \nonumber 
\label{eq:over2}
\end{eqnarray}
が、正定値性を満たしているのが望ましいと思われる。しかし、
PAWや現在のlmfではそれは保証されていない。検討の余地がある。
[ひとつの考え方としては、各$a$サイトにおいて、
$\int_{|\bfr| <R_a} d\bfr F^*_{0i}(\bfr) F_{0i}(\bfr)  
>\int_{|\bfr| <R_a} d\bfr F^{*}_{2i}(\bfr) F_{2i}(\bfr)$ 
となるようにとると、これを自然にみたすことができる。
すなわち各サイトにおいて、もとのenvelope関数の二乗積分のほうが、それを射影して得た$F_{2i}$の二
乗積分よりおおきくなっていればよい。
このためには、$F_{2i}$を切り出すprojectorの関数が正規直行系であればよい。
検討の余地がある。]
}

One-body problem for a given one-particle potential $V(\bfr)$ in real
space is translated into a problem in the 3-component space for the
Hamiltonian $H=T+V$ under the condition (A) or (A'), where $V=V_0 \oplus
\{V_{1,a}\} \ominus \{V_{2,a}\}$.  Here $V_0(\bfr)=V(\bfr)$, and
$V_{1,a}(\bfr)=V_{2,a}(\bfr)=V(\bfr+\bfR_a)$ within MTs at
$\bfR_a$. However, we can add any extra potential $\Delta \bar{V}$
simultaneously to both of $V_0$ and $V_{2,a}$ if (A) is completely
satisfied.

We have an error because we use \req{fnmap} instead of \req{eq:calRF}:
high energy contributions contained in the 0th components are not
exactly evaluated. However, the error can be small enough to be
neglected as discussed in Appendix \ref{sec:zeroonetwo}.  This error is
also related to a question, how to choose the optimum $\Delta \bar{V}$
so as to minimize the error.  In fact, the success of the PAW \cite{PAW}
is dependent on the choice of $\Delta \bar{V}$ as seen in
\refsec{sec:comparison}.

The valence electron density $n$ as the 3-component function is given by
\begin{eqnarray}
n &=&n_0\ooplus n_1 \oominus n_2 = n_0 \ooplus \{n_{1,a}\} \oominus \{n_{2,a}\} =
\sum_{ij} \rhoij F_i^* F_j = \sum_{ij}
 \rhoij F^*_{0i}(\bfr)F_{0j}(\bfr) \nonumber \\
&&\ooplus  \{ \sum_{ij} \rhoij F^*_{1i,a}(\bfr)F_{1j,a}(\bfr) \}
\oominus   \{ \sum_{ij} \rhoij F^*_{2i,a}(\bfr)F_{2j,a}(\bfr) \}. \label{eq:n}
\end{eqnarray}
\end{widetext}
%$\sum_{ij} \rhoij F_i^*(\bfr) F_j(\bfr')$. As we see in
%\refsec{sec:augment}, this behaves as the one-body density
%matrix only when $\bfr \approx \bfr'$.
We can calculate the Coulomb interaction from $\calR[n]$. 
However, to reduce the computational effort, 
we will also make the Coulomb interaction into the separable form as
seen in \refsec{sec:coulomb}, with the help of multipole technique
due to Weinert \cite{weinert81}.
In \refsec{sec:multi} and \refsec{sec:frozencore}, we give some
preparations to define the Coulomb interaction in \refsec{sec:coulomb}.

The total energy should be given as a functional of eigenfunctions in
the first-principle calculations, not just as a functional of
coefficients $\{\alpha^j_p\}$.  This is important in some cases. For
example, it is necessary to know how the change in the basis set affects
the total energy when we calculate atomic forces. These are related to
the so-called Pulay terms \cite{pulay69}.

\req{eq:n}などの式で、我々は、angular-momentum cutoffを行う。
それは$F^*_{1i,a}(\bfr) F_{1j,a}(\bfr)$と
$F^*_{2i,a}(\bfr) F_{2j,a}(\bfr)$の high $l$ contributions
を正確に取る意義がないからである。
角運動量合成則から$2\times l_{{\rm max},a}$までの成分がこの
\req{eq:n}の第１、２成分に現れるが、それの$l_{{\rm max},a}$より上の成分
は捨てることにする。このカットオフは
$O_{ij}$ and $T_{ij}$には影響しない：これらは積分の結果、合成後のs成分
のみしか効かないためである。
%これら$O_{ij},T_{ij}$ and $n$は
%$\sum_{ij} \rhoij F_i^*(\bfr) F_j(\bfr')$. As we see in
%\refsec{sec:augment}, this behaves as the one-body density
%matrix only when $\bfr \approx \bfr'$.

この$n$から$\calR[n]$を作ると$\Omega$での電子密度が作れる。
クーロン相互作用は原則的にその$\calR[n]$から評価できる。
しかし\refsec{sec:coulomb}で説明するように、計算を簡単にするため、
更なる近似をおこなってそれを評価することにする。結果として、そのクーロン相互作用は
$\calR[n]$の関数としてではなく、$n$の直接の関数として与えられることになる。
以下のSec.\ref{sec:multi} と \refsec{sec:frozencore}では、これを説明す
るための予備的な準備を行い、the Coulomb interactionを
\refsec{sec:coulomb}で定義する。それで最終的には3成分関数の基底の張る空間において
モデル化された量子力学が定義されたことになる。

3-component augmentationの手法の２つの問題点を指摘しておく。
一つ目は正定値性の問題である。
\req{eq:norm}の最後の項は負の寄与をあたえるので、
$O_{ij}$が正定値行列となっていない可能性がある。
これを避けるには、基本的には、
$\intaa d^3r \left(F^*_{0}(\bfr)F_{0}(\bfr)-F^*_{2,a}(\bfr)F_{2,a}(\bfr)\right)>0$ 
が任意の基底関数の線型結合$F$について成り立つようしておくべきである。
現状のPMT法のimplementatioでは、カットオフパラメーターが有限の
値の時には必ずしも満足されない。しかしカットオフパラメーターを十分に
大きくとることで対応できている。
%We think that the PAW method in \cite{kresse99} is
%designed to satisfy this condition.
二つ目は、``null-space problem''である。
この問題を簡単に示すため以下の場合を考える。まずはMT内のみで違いのある
二つのenvelope関数（あるいはenvelop関数の重ね合わせ）を考えてみる。
そのとき、その差となる関数が``null envelop function''である。
これはMT内でのみ値をとるenvelop関数であり、これをaugmentしたものをnull
basisと呼ぶ。これの1st componentはゼロである。
カットオフが非常に大きい極限を考える。このときには、
Hamiltonian $H_{ij}$ (後の\req{eq:v} あたりで説明)と 
$O_{ij}$の固有値がどちらもゼロになってしまう。これはある種のゴーストである。
実際、基底関数を大きくとるとき、このnull basisが問題になる。
これは結果としてコントロール不能な固有値をもつ固有ベクトルを生じえるし、
あるいは、他の固有関数と不定な結合をつくって、非常に奇妙に変形させてしまう。
（$n_2$の積分値が異常に大きくなって計算が数値的に破綻したりすることが起こる）。
これはPMT法のみならず一般的なaugmentationの方法において現れ得る
課題である。現状においては、基底の数がこのような異常が起こらない範囲にと
どめて計算を行っている。実際、結果で見られるように、そのような範囲内でも十分に安定し
た結果が得られている。
この2番目の問題は大きく言えば1番目の問題と同義であり、
「数値的な意味で3-componentの基底関数の張る空間を正定値で安定であるように
保ちながら系統的に大きくしていく」ことが安定してできるようにしていくこと
が望ましいが、これは将来的課題である。

まとめて言って、augmentationにかかわるcutoff parameterは
$l_{{\rm max},a},k_{{\rm max},a}$であった。$\EMAX$によりAPWの数はコント
ロールされた。また0th component$F_{0i}(\bfr)$ を$\Omega$で表現するために
その実空間メッシュのカットオフエネルギー$\EMAXm$が必要である。
我々の手法では、$F_{0i}$とその二乗である$n_0$に対しての実空間メッシュは同じにとっている。



------------------------\\
浅いコアについてはctrlファイルでPZを指定することでloをもちいて扱う
（注：デフォルトのPをセミコアにするときは、大きい整数値をもつPを指定する
必要あり。たとえばFeだとデフォルトで3dがvaleceなので
これをセミコア扱いして、「PZ=0,0,3.8 P=0,0,4.2」とすれば3d,4dをvalenceに
入れることができる。ただ、4dはある程度はPWでカバーできる。（実際こういう
設定を使うこともあるが、その有効性はもうすこし検証する必要あり）。

{\small 
ほかにもctrlPZを13.8などとして、eloをつかう（局在MTOにそのハンケル関数のtailを付け加える
方法）のもある。ただ数値的安定性などの点から現在はあまり利用していない。
注：このときには、semi-coreのエネルギーlevelで、MT内でradial schr\"odinger eq.を解く。
そして、それをMT外部へsmooth Hankel関数に接続した局在化基底をもちいる。
この処方箋は基本的には、通常のvalence電子に対してもちいるMTOとおなじであるが、
この場合envelope関数のsmooth Hankelを指定するパラメーターは自動最適化される。
このsemi-coreをつかうには、ctrlファイルではPZ＝12.5などとして+10でいれる。
（この場合(extended local orbital)はloの一種と言うよりMTOである。通常の
local orbitalではMT内でのみ値をとる。}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{multipole transformation}
\label{sec:multi} 
次のSec.\ref{sec:coulomb}でのクーロン相互作用の定義のために
the multipole transformation ($\MM$-transformation) を定義しておく。これ
はthe 3-component functionsを定義域、値域とするものである。\\
In order to define Coulomb interaction in
Sec.\ref{sec:coulomb}, we introduce the multipole transformation
($\MM$-transformation) for the the 3-component functions.  This
corresponds to the compensation charges in Ref.\cite{PAW}.

Before defining the $\MM$-transformation, we define the gaussian
projection $\GG_a \left[f(\bfr)\right]$ as follows.  The projection
$\GG_a \left[f(\bfr)\right]$ is defined for the function $f(\bfr)$ for
$|\bfr|\leq R_a$ as
\begin{eqnarray}
&&\GG_a \left[f(\bfr)\right]
=\sum_L Q_{aL}[f] G_{aL}(\bfr), \label{eq:gdef} \\
&&G_{aL}(\bfr)= \frac{1}{N_{aL}} \exp\left(-\left(\frac{r}{\RGSa}\right)^2\right)
Y_L(\hat{\bfr}),\label{eq:gl}
\end{eqnarray}
where $Q_{aL}[f]=\intaa \YY(\bfr) f(\bfr) d^3r$
gives the $L$-th multipole moment of $f(\bfr)$.
$N_{aL}$ is a normalization factor
so that $G_{aL}(\bfr)$ has a normalized multipole moment.
%Ritht? $N_{aL}=1/(\sqrt{\pi}RGS,a)^{3/2}}$
$\RGSa$ in \req{eq:gl} is chosen small enough so that $G_{aL}(\bfr)$ is
negligible for $|\bfr|\geq R_a$ (See Eq.(25) in
Ref.\cite{lmfchap}). This $\GG_a \left[f(\bfr)\right]$ is a
superposition of gaussians $G_{aL}(\bfr)$ with keeping the multipole
moments of $f(\bfr)$.  We can take rather small $\RGSa$ without loss of
numerical accuracy; it is possible to take a limit $\RGSa \to 0$ because
quantities involved in $G_{aL}(\bfr)$ are evaluated analytically or
numerically accurately on a dense radial mesh.

We now define $\MM$-transformation for
3-component density $n= n_0 \ooplus n_1 \oominus n_2$ as
\begin{widetext}
\begin{eqnarray}
&&\MM[n]=  n_0(\bfr) \nonumber \\
&&+ \sum_{a,\bfT,L} Q_{aL}[n_{1,a}\!-\!n_{2,a}]G_{aL}(\bfr-\bfR_a-\bfT) 
\ooplus n_{1} \oominus 
\{n_{2,a}(\bfr) + \sum_L Q_{aL}[n_{1,a}\!-\!n_{2,a}]G_{aL}(\bfr) \}. \label{eq:multi}
\end{eqnarray}
\end{widetext}
Thus $\MM[n]$ adds the same gaussians to both of the 0th and 2nd
components.  $\bfT$ is the translational vectors of $\Omega$.  With this
transformation, the multipole moments of the 1st and 2nd components become
the same.  Note that the $\MM$-transformation is not a physically
meaningful transformation because $\calR[\MM[n]]=\calR[n]$.  With this
transformation, interstitial electrostatic potential calculated from the
0th component of \req{eq:multi} should be the same as that calculated
from $\calR[n]$.

$\MM[n]$ は単に、gaussiansを第2成分と第0成分に同じだけ付け
加える変換である。ここで$\bfT$ はセルの translational vectorsである。
この変換では$\calR[\MM[n]]=\calR[n]$であることはあきらかであるから、
the $\MM$-transformationはゲージ変換などと同様に、物理量を変換するもので
はない。ただ、この変換により、the 0th component of \req{eq:multi}でつく
られるthe interstitial electrostatic potentialは$G_{aL}$の寄与が正しく評
価される限りにおいて、$\calR[n]$で作られるものと一致することになる。

------------\\
＊将来的に,以下の静電エネルギー$E_{\rm es}$を「多重極変換せずに直接にすべての項をとって評価する」
という改良を考えていいんじゃないかと思う。多重極変換などが不要でむしろ簡
単になる。逆にいえば、「現在のimplementationにおいて、
（一見きれいな風には見えるが）なぜ、多重極変換にこだわって$E_{\rm es}$
を評価する必要があるのか？」という疑問がある。メリットがあるかどうか検討必要。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Coulomb interaction}
\label{sec:coulomb} 
\refsec{sec:eigenfunction}で述べた処方箋にしたがえば、
二つの電子密度$n(\bfr)=n_0\oplus n_1 \ominus n_2$ と
$m(\bfr)=m_0 \oplus m_1 \ominus m_2$  の間のクーロン相互作用は、
$\Omega$の電子密度$\calR[n]$と$\calR[m]$から計算すればよいことになる。
また一方、全節で述べたように
$\bar{n}=\MM[n]$ は $\calR[\bar{n}]=\calR[n]$ をみたしている( $\bar{m}$
についても同様).したがって、われわれは$\calR[\bar{n}]$ を $\calR[n]$ 
の代わりに使うことができる。なのでクーロン相互作用は、以下の\req{eq:coulomb0}
と書くことができる。ここで $v(\bfr)=e^2/|\bfr|$である。
和の記号$\sum_{\bfT}$には、セルの数での割り算が含まれているものと解釈することとする。
しかしながら、この\req{eq:coulomb0}は$v(\bfr-\bfr'+\bfT)$
が0th componentを他のcomponentとつなぐような
クロスタームを含んでいるため数値的に評価するのは面倒である。
それでここでは\req{eq:coulomb0}の代わりの近似形として、\req{eq:coulomb}で
クーロン相互作用を評価することとする。

In principle, we can define the Coulomb interaction
between $n(\bfr)=n_0\ooplus n_1 \oominus n_2$ and $m(\bfr)=m_0 \ooplus
m_1 \oominus m_2$ from the densities $\calR[n]$ and $\calR[m]$.  We can
use $\calR[\bar{n}]$ instead of $\calR[n]$ where $\bar{n}=\MM[n]$
satisfies $\calR[\bar{n}]=\calR[n]$, and $\calR[\bar{m}]$ as well.  Thus
the Coulomb interaction $\left(n|v|m\right)_{\rm original}$ is given as
\begin{widetext}
\begin{eqnarray}
\left(n|v|m\right)_{\rm original}=\sum_{\bfT} \int_\Omega d^3r d^3r' 
\calR[\bar{n}(\bfr)] v(\bfr-\bfr'+\bfT) \calR[\bar{m}(\bfr')].
\label{eq:coulomb0}
\end{eqnarray}
Here $v(\bfr)=e^2/|\bfr|$; $\sum_{\bfT}$ implicitly includes the
division by number of cells. Equation~(\ref{eq:coulomb0}) can not be
easily evaluated because $v(\bfr-\bfr'+\bfT)$ contains the cross terms
which connect the 0th component with other components.

Thus we use an approximation 
\begin{eqnarray}
\left(n|v|m\right)\equiv\MM[n] \cdot v \cdot \MM[m] = \bar{n} \cdot v \cdot \bar{m}, \label{eq:coulomb}
\end{eqnarray}
instead of $\req{eq:coulomb0}$, where dot operator for the 3-component
functions is given as
\begin{eqnarray}
&&\bar{n} \cdot v \cdot \bar{m} \equiv
\bar{n}_0 \bullet v \bullet \bar{m}_0 + \bar{n}_{1} \circ v \circ
\bar{m}_{1} - \bar{n}_{2} \circ v \circ \bar{m}_{2}\\
&&\bar{n}_0 \bullet v \bullet \bar{m}_0 \equiv \sum_{\bfT} \int_\Omega d^3r d^3r' \bar{n}_0(\bfr)v(\bfr-\bfr'+\bfT) \bar{m}_0(\bfr'), \label{eq:n0vn0}\\
&&\bar{n}_1 \circ v \circ \bar{m}_1 \equiv 
\sum_a \inta d^3r \intad d^3r' \bar{n}_{1,a}(\bfr)v(\bfr-\bfr') \bar{m}_{1,a}(\bfr'), \label{eq:n1vn1}\\
&&\bar{n}_2 \circ v \circ \bar{m}_2 \equiv \sum_a \inta d^3r \intad d^3r' \bar{n}_{2,a}(\bfr)v(\bfr-\bfr') \bar{m}_{2,a}(\bfr'). \label{eq:n2vn2}
\end{eqnarray}
Note that $X \bullet Y$ means integral over $\Omega$, whereas $X \circ
Y$ means integrals within MTs.\\
ここで、the dot operator($\bullet$や$\circ$)を用いた $X \bullet Y$ は $\bfr$(もしくは$\bfr'$)
に関する積分を表している; 積分の領域はdot operatorの両サイドで同じでなけ
ればならない。 $X(\bfr) \bullet Y(\bfr)$はスカラーとなるし、
$X(\bfr) \bullet Y(\bfr,\bfr')$ は $\bfr'$ に関する関数となる（これは
Einstein's sum ruleと似た取り決めである).この\req{eq:coulomb}においては$\calR$-mapping
はつかわれていないことになる。

ここで、元来の\req{eq:coulomb0}と、その近似形である\req{eq:coulomb}の差
を評価しておく。\\
Let us evaluate the difference between \req{eq:coulomb0} and \req{eq:coulomb}.
This can be evaluated with the identity in Appendix \ref{sec:zeroonetwo} as
\begin{eqnarray}
&&\left(n|v|m\right)_{\rm original}-\left(n|v|m\right)= 
\sum_a \inta d^3r \intad d^3r'\Big(
\left( \bar{n}_0(\bfr) \!-\! \bar{n}_2(\bfr) \right) 
v(\bfr\!-\!\bfr') \left( \bar{m}_1(\bfr')\!-\!\bar{m}_2(\bfr') \right)  \nonumber \\
&&+\left( \bar{n}_1(\bfr)\!-\!\bar{n}_2(\bfr) \right) 
v(\bfr\!-\!\bfr') \left( \bar{m}_0(\bfr')\!-\!\bar{m}_2(\bfr') \right)\Big).
\label{eq:coulombdiff}
\end{eqnarray}
This is essentially the same with Eq.(13) in Ref.\cite{kresse99}.  In
\req{eq:coulombdiff}, the difference consists of contributions from MT
sites without terms connecting different MT sites. This is because
$\bar{n}_{1,a}(\bfr)$ and $\bar{n}_{2,a}(\bfr)$ have the same multipole
moments.  Since $\bar{n}_0(\bfr') - \bar{n}_2(\bfr)$ is high-$l$ or
highly oscillating part, and $\bar{n}_{1,a}(\bfr)-\bar{n}_{2,a}(\bfr)$
has zero multipole moments and zero at MT boundaries, we expect that the
separable form of \req{eq:coulomb} should be justified. We can check
this with changing the truncation parameters $l_{{\rm max},a}$ and 
$k_{{\rm max},a}$.

From \req{eq:coulomb}, we have the expression of the Coulomb
interaction as
\begin{eqnarray}
\left(F^*_i F_j|v|F^*_{i'}F_{j'}\right) = \MM[F^*_iF_j] \cdot v \cdot \MM[F^*_{i'}F_{j'}].
\label{eq:ffvff}
\end{eqnarray}
Here $F^*_i F_j$ is the diagonal product defined in \req{fnproduct} at
$\bfr=\bfr'$.  In calculations such as arising in the $GW$
approximations \cite{kotani07a}, we have to evaluate this as accurately
as possible so that the exchange-pair cancellation is kept well.

現在のPMT法のimplementationにおいては、
Eqs.(\ref{eq:n1vn1},\ref{eq:n2vn2})におけるーロン相互作用
$v(\bfr-\bfr')$を、別の境界条件を満たすグリーン関数
$w(\bfr,\bfr')$で置き換えて計算している。ここで、境界条件は、MT球の表面
をゼロ電位にとるようなものである（MT球を金属板であると考えアースしているのと同じ）。
この$w(\bfr,\bfr')$をもちいても結果は変わらない；境界条件の違いは、差を
とることで打ち消されるからである。結果、
\req{eq:coulomb} の代わりに、
\begin{eqnarray}
&&\left(n|v|m\right)=\bar{n} \cdot v \cdot \bar{m} = 
\bar{n}_0 \cdot v \cdot \bar{m}_0 + \bar{n}_{1} \cdot w
\cdot \bar{m}_{1} - \bar{n}_{2} \cdot w \cdot \bar{m}_{2}. \label{eq:defnvm}
\end{eqnarray}
として、クーロン相互作用を計算することができる。


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Frozen core approximation}
\label{sec:frozencore} We often need to treat spillout of the core
density outside of MTs explicitly. Then we use the frozen core
approximation; the charge density due to the cores are evaluated by a
superposition of rigid cores as follows \cite{lmfchap}.

Frozen core近似はLFOCA＝１の場合（デフォルト）である。
まず原子のコアをlmfaで孤立原子において計算しておく。最近では通常、非磁性状態の電子の詰め方で計算している。
これをMT半径内でスムーズ化したものを$n^{\rm c}_{\rm sH}(\bfr)$とする（電荷の規格化がなされてい
る必要はない）。この$n^{\rm c}_{\rm sH}(\bfr)$は、MT外においては、孤
立原子で計算したコアの電荷密度を再現するものである。
これを用いて,各原子に対して、コアの電子密度$n^{\rm c}(\bfr)$
を以下の3成分表示の形であたえておく。サイトのindex $a$は省略している。
\begin{eqnarray}
n^{\rm c}(\bfr)= 
n^{\rm c}_{\rm sH}(\bfr)
+ n^{\rm c}(\bfr)- n^{\rm c}_{\rm sH}(\bfr)
\label{eq:nc}
\end{eqnarray}
この右辺の各項が、第0,1,2成分である。第0成分がスムーズ化した$n^{\rm c}_{\rm sH}(\bfr)$
である。また、第１、２成分は当然、MT内のみの成分である。corprm.fで計算されるcofh
が、$n^{\rm c}_{\rm sH}(\bfr)$に対する重みであり,MTの外の電子密度が
正確に再現されるようになっているようである（要確認）。
lmfにおいては、この$n^{\rm c}_{\rm sH}(\bfr)$は
smooth Hankelでフィットされたものを用いており全空間にひろがっている。
（そもそもは、smooth Hakelは波動関数をフィットするためのものであって電子
密度をフィットするものではなかったが解析性などを考えこれを用いている）。
smooth Hankelの解析性のために、静電相互作用などの計算が容易になる。
フィットの係数とsmooth Hankelを指定するパラメーター
は適当に決定されている；fp/locpot.Fのlocpt2のドキュメントなど参
照.cofg,cofh,ceh,rfocなど。また詳細を書くこと。wiki?。\\
First, we perform a self-consistent atomic calculation under the
spherical approximation without a spin polarization to obtain its core
density $\nc_a(\bfr)$. Then we make a fitted density $\nc_{{\rm
sH},a}(\bfr)$ given by a linear combination of several \smh\ functions
so that $\nc_{{\rm sH},a}(\bfr)$ reproduces $\nc_{a}(\bfr)$ for
$|\bfr|>R_a$ within a numerical accuracy. Since $\nc_{{\rm H},a}(\bfr)$
are analytic and smooth at their centers, we can treat them numerically
accurately (we can use other kinds of analytic functions such as
gaussians instead of \smh\ functions).
  
Thus we have the expression of all the core electron density with adding
contribution from nucleus $-Z_a\delta(\bfr)$:
\begin{eqnarray}
\nzc = \sum_{a,\bfT} \nc_{{\rm sH},a}(\bfr-\bfR_a-\bfT) \ooplus
\{\nc_{a}(\bfr)-Z_a\delta(\bfr) \} \oominus \{\nc_{{\rm sH},a}(\bfr) \}.
\label{eq:nzc}
\end{eqnarray}
Applying the $\MM$-transformation to $\nzc$ gives
\begin{eqnarray}
\MM[\nzc]
&=& \sum_{a,\bfT} 
\left( \nc_{{\rm sH},a}(\bfr-\bfR_a-\bfT)+\sum_L Q_{aL}^{\rm Zc} G_{aL}(\bfr-\bfR_a-\bfT) \right)\ooplus
\{\nc_{a}(\bfr)-Z_a\delta(\bfr)\} \nonumber \\
&& \oominus \{ \nc_{{\rm sH},a}(\bfr)+\sum_L Q_{aL}^{\rm Zc}G_{aL}(\bfr)\},\label{eq:nc} \\
Q^{\rm Zc}_{aL} &=& Q_{aL}[\nzc_1-\nzc_2] =
Q_{aL}[\nc_{a}(\bfr)-Z_a\delta(\bfr)-\nc_{{\rm sH},a}(\bfr)] \label{eq:qalnzc}.
\end{eqnarray}


コアは、lmfではFrozen core近似で扱う(ctrlの設定でLFOCA=1)のが基本である。
これで、コア電子密度は、上述のように3成分表示で表現されることになる。
浅いコアはlocal orbitalで扱わざるをえない。
LFOCA＝０（MT内に閉じ込めた条件である（無理にMT内に局在させて解く））より
LFOCA=1のほうがよい。
深いコアでMT内に十分に局在してるものなら、LFOCA=1でもLFOCA=0でもかまわない。
しかし、もし、NMRなどでコア位置での電場などを真面目にときたいのなら、LFOCA=0の方
がいいかもしれないし、そもそもAkaiKKRのradial schoredinge方程式を解くルーチンを組み
込んだ方がいいかもしれない（あるいはlmfに組み込まれているlocpot.F elfigr
でOKなのかもしれない。確認必要。)
全エネルギーに対してコアは、「コアの運動エネルギー」と「コアの電子密度」を通じて寄与する。
Frozen core近似では、孤立原子の計算によって、それらを決定して用いる。
とくに、電子密度に関しては、孤立原子に関して得たものを単純に重ね合わせて固体
中のコア電子密度とする。（LFOCA=0の近似では、MT内で解いて決定する）。

\ \\

MT内にコアが局在するLFOCA=0の場合においては、
上の式において、$n^{\rm c}_{\rm sH}$の項を除いたものとなる。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5
\subsection{total energy in density functional}
\label{sec:total} Let us give the total energy $E_{\rm total}$ for the
DFT, and construct the Kohn-Sham equation from it. With the kinetic
energy $\ek=\frac{1}{2m_e} \sum_{ij} \rhoij \langle \nabla F_i| \nabla
F_{j} \rangle$ from Eq.(\ref{eq:kin}), the total energy is given as:
\begin{eqnarray}
E_{\rm total}=\ekcore+ \ek+E_{\rm es}+E_{\rm xc},
\label{eq:etot}
\end{eqnarray} 
where $\ekcore$ is the kinetic energy of frozen cores as a constant.
$E_{\rm es}$ and $E_{\rm xc}$ are electrostatic and exchange-correlation
energies, respectively.
$E_{\rm es}$ is given as the electrostatic energy for the
total density $\nzcv =\nzc +n $, which are given in
Eqs(\ref{eq:n},\ref{eq:nzc}). 

Based on the definition \req{eq:ffvff}, we have
%=\nzc(\bfr) +\sum_{ij} \rhoij F_i^*(\bfr) F_j(\bfr)$ as:
\begin{eqnarray}
E_{\rm es}= \frac{1}{2} (\nzcv|v|\nzcv)=\frac{1}{2} \MM[\nzcv] \cdot v \cdot \MM[\nzcv],
\label{eq:es}
\end{eqnarray}
where a constant due to the self-interaction of nucleus is implicitly
removed. 
Components of $\barnzcv(\bfr)=\MM[\nzcv]$ are given as
%contains smHankel from  $\nzc(\bfr)$, Gaussians $G_{aL}$ due to ${\cal M}$
%transformation, and the density on real space mesh due to $F^*_{0i}(\bfr)F_{0j}(\bfr)$:
\begin{eqnarray}
&&\barnzcv_0(\bfr)= \nzc_{0}(\bfr)
%\sum_a \nc_{{\rm sH},a}(\bfr-\bfR_a) 
+ \sum_{a,L,\bfT} 
(Q_{aL}^{\rm Zc}+Q^{\rm v}_{aL})G_{aL}(\bfr-\bfR_a-\bfT)+ n_0(\bfr),
\label{eq:barn0zcv}\\
&&\barnzcv_{1,a}(\bfr)=\nzc_{1,a}(\bfr) +n_{1,a}(\bfr), \label{eq:barn1zcv}\\
&&\barnzcv_{2,a}(\bfr)=\nzc_{2,a}(\bfr) 
+\sum_L (Q_{aL}^{\rm Zc}+Q^{\rm v}_{aL})G_{aL}(\bfr)+n_{2,a}(\bfr),\label{eq:barn2zcv}
\end{eqnarray}
where $Q^{\rm v}_{aL}=Q_{aL}[n_{1,a}-n_{2,a}]$.  We expand
$F^*_{0i}(\bfr)F_{0j}(\bfr)$ of $n_0$ in $\{e^{i \bfG \bfr}\}$ (to
obtain coefficients, $F^*_{0i}(\bfr)F_{0j}(\bfr)$ is tabulated on a
real-space mesh, then it is Fourier transformed).  The cutoff on $\bfG$
is specified by $\EMAXm$.  Then the 0th components in \req{eq:barn0zcv}
is represented by sum of analytic functions. Thus we can finally
calculate $\frac{1}{2} \barnzcv_0(\bfr) \bullet v \bullet
\barnzcv_0(\bfr)$ in $E_{\rm es}$.  Terms between gaussians located at
different MT sites are evaluated with the Ewald sum treatment.  The
terms related to MTs in $E_{\rm es}$ is $ \frac{1}{2} \barnzcv_1 \circ
\RR \circ \barnzcv_1 - \frac{1}{2} \barnzcv_2 \circ \RR \circ
\barnzcv_2$, which is calculated on a radial mesh accurately.

The exchange correlation term can be defined as
\begin{eqnarray}
E_{\rm xc}[\nzcv] = E_{\rm xc}[\nzcv_0] 
+  \sum_a E_{\rm xc}[\nzcv_{1,a}]  
-  \sum_a E_{\rm xc}[\nzcv_{2,a}].
\label{eq:exc}
\end{eqnarray}
The functional derivatives of $E_{\rm xc}[\nzcv]$
with respect to each component of $\nzcv$ gives
\begin{eqnarray}
v^{\rm xc} = v^{\rm xc}_0(\bfr)
\ooplus  \{v^{\rm xc}_{1,a}(\bfr)  \}
\oominus \{v^{\rm xc}_{2,a}(\bfr)  \}.
\label{eq:vxc}
\end{eqnarray}
%%%%% Need to be improved if we write something here...
%% We evaluate $E_{\rm xc}[\nzcv_0]$ on real-space mesh.
%% Though $\nzcv_0$ is expanded in the $G$ vector, $\nzcv_0$
%% keeps translational symmetry. However,
%% we use real-space meshing in the evaluation of 
%% $E_{\rm xc}[\nzcv_0]$, this can slightly break the translational
%% symmetry. In anyway, there remains a future problem that how to avoid dense
%% real-space mesh for the calculations;
%% problem is not in the absolute value of the total energy, but in its systematic error
%% when we move atomic positions $\bfR_a$ relative to the grids of real-space mesh.
%% Note that $E_{\rm es}$ do not have this problem since all quantities 
%% are analytically treated for a given cutoff $\EMAXm$.

To determine the ground state, 
$E_{\rm total}$ should be minimized under the orthogonality of eigenfunctions with
the constraint (A') and (B).
This ends up with 
$\delta \psi^*_p \cdot (H - \epsilon_p) \cdot \psi_p =0$ for
the variation $\delta \psi^*_p$ which satisfy (A') and (B). 
Here the operator $H=T+V$ is given as
\begin{eqnarray}
&&T=\frac{-\nabla^2 }{2m_e} \oplus \left\{\frac{-\nabla^2 }{2m_e}\right\} 
\ominus \left\{\frac{-\nabla^2 }{2m_e}\right\} \\
&&V= 
\barnzcv_0 \bullet v \bullet + v^{\rm xc}_0
\ooplus
\left\{ \sum_L
{\cal Q}^{\rm v}_{aL} \YY_L(\bfr)
+ \barnzcv_{1,a} \circ \RR \circ + v^{\rm xc}_{1,a} 
\right\} 
\oominus
\left\{ \sum_L
{\cal Q}^{\rm v}_{aL} \YY_L(\bfr)
+ \barnzcv_{2,a} \circ \RR \circ + v^{\rm xc}_{2,a} 
\right\}, \label{eq:v} \\
&&{\cal Q}^{\rm v}_{aL}\equiv \frac{\partial E_{\rm es}}{\partial {Q}^{\rm v}_{aL}} =
\barnzcv_0 \bullet v \bullet G_{aL}(\bfr'-\bfR_a)
-\barnzcv_{2,a} \circ \RR \circ G_{aL}(\bfr'), \label{eq:calqdef}
\end{eqnarray}
where $\bar{n}_0 \bullet v \bullet$ means an integral on a variable, resulting a function of $\bfr$.

When a basis set $\{F_j(\bfr)\}$ satisfying (A') and (B) are fixed, we
just need to consider variation with respect to $\alpha_{p}^{i*}$ in
\req{eq:eig}. Then we have
\begin{eqnarray}
\sum_j (H_{ij} -\epsilon_p O_{ij}) \alpha_p^j =0,
\label{eq:eigenp}
\end{eqnarray}
\end{widetext}
where $H_{ij}= \langle F_i| H |F_{j} \rangle = 
\langle F_i| \frac{-\Delta}{2m} + V |F_{j} \rangle =T_{ij}+V_{ij}$.
$V_{ij}=\langle F_i|V|F_{j} \rangle=V \cdot F^*_i F_j$. 
%Here an
%operator in 3-component 
%$V=\frac{\delta E}{\delta n}=V_0\ooplus V_1 \oominus V_2$ is given as
%where terms including $\dot{Q}^{\rm v}_{aL}$ comes from the derivative
%through $Q^{\rm v}_{aL}$ in \req{eq:barn0zcv} and in \req{eq:barn2zcv}.
Then the total energy minimization results in the eigenvalue problem.
The matrix elements $O_{ij},T_{ij}$
and $V_{ij}$ are given in Appendix \ref{onsitematrix}.

The formula to evaluate atomic forces are given in Appendix
\ref{sec:force}. It is directly evaluated from the variation on the
total energy. This procedure is considerably simplified than that given
in Refs.\cite{lmfchap,molforce}. 

%In addition, we can show that the
%atomic forces are not dependent on the real-space mesh relative to the
%atomic positions as shown in Appendix \ref{sec:realmesh}. This is
%important to allow relaxations of atomic positions and to perform
%first-principle molecular dynamics.

----\\
$E_{\rm es}$の第0項に関しては、mkpot.F内のsmves.Fで評価している。
この中で、Gaussian$\times$smooth partの積分やGaussian$\times$Gaussianの積分が出て
くる。後者については、off-siteの部分に関しては、単純に多重極のエバルト和で評価できる。
第1項第2項に関しては、locpot.Fで評価している。


\begin{quote}
ーーー以下は古い記録：たぶん無視してよい　ーーー\\
local orbital(LAPW的な時、あるいはMTO的な時でも)のときには、現在
のlmfのコードにおいては,どうも、それに対応する$\pi^{\rm local}$の積分(see \cite{lmfchap})
がきちんと入ってるのかどうかが疑問である。いいかえると、local orbitalに対応
する電子密度に関しては、多重極変換できていないかもしれない($\barnzcv_{1,a}$と$\barnzcv_{2,a}$の
多重極が一致するように実装できていないということ）。
fp/smves.Fでは、MT boundaryでゼロとせずに、$\barnzcv_0$
の解でのMT boundaryでの値を計算するルーチンを入れている（call mshvmt).
(よくわからないので調べる必要あり）。
ただ、数値精度に問題はあってもそれなりにはちゃんと答えはだせてるのだろう。
追記：ちょっと別の話であるが木野氏から、
ルーチンmshvmtが数値的におかしい(これに含まれるspherical bessel funをつ
くるropbesのため)との指摘あり。
\end{quote}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5
\section{PMT method}
\label{sec:pmtmethod} Let us give the PMT method based on the
3-component formalism in \refsec{sec:formalism}. Based on it, we need to
specify a basis set $\{F_i\}$.  In the PMT, $\{F_i\}$ is classified into
three kinds of subsets as follows:
PMT法は,より正確には以下、(c)を含めて3種類の基底関数を用いることになる。
\begin{itemize}
\item[(a)] APW. We augment the PW in the manner as will be shown later.

\item[(b)] MTO. We augment the atom-centered \smh\ functions. 
           %Its centers are at $\bfR_a$. 
           %We take Bloch sum of \smh\ to satisfy crystal symmetry.
           %The head part is augmented analytically (thus perfectly
           %augmented);  the tail part is
	   %augmented in the manner of \refsec{sec:augment}. 
           %As we explain in \ref{sec:result}, we usually use two MTOs for
           %each $aL$ channel, although we use three MTOs in some cases.
           %, except
           %some cases. For $sp$ channel for rare gas and $d$ channel
           %for Cu through As, we use three MTOs.

\item[(c)] Local orbital (Lo) \cite{lo}.
   We use this to represent some degree of freedom in MTs,
   such as semicore states. The envelope function of Lo is zero overall.

\end{itemize}
%we use three kinds of 
%The PMT method uses wo kinds of augmented basis, the APW and the MTO
%for valence electrons. These are made of smooth functions 
%called as ``envelope functions'' through an augmentation procedure.
%xxxxxxxx
%For the envelope functions in the PMT method, we use the PW for the APW, and
%the smooth Hankel (\smh) function for the MTO. In addition, it uses local orbitals.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%\subsection{one-center expansion}
%\label{sec:onecenter}
(a),(b)はエンベロープ関数をaugmentationすることで作られる。
エンベロープ関数として、APWについてはPWを、MTOについては、
\smh をもちいる(以下説明あり)。
(b)と(c)は原子を中心とする局在基底であり、周期境界条件を考えると、
Bloch和をとって基底関数とすることになる。

基底関数のインデックスの集合は$i\equiv\{\bfG,aLn\}$である。すなわち、
$i$は,$\bfG$か$aLn$のどちらかをとる。$\bfG$ は (a)をあらわし、$aLn$は (b)または
(c)をあらわす。ここで$n$は与えられた$aL$に対して
MTOの種類やloを指定するindexである.（$n$が電子密度の記号と重なってしまっているが、
あとからこれは出てこないのでとりあえず問題ない。$a$は最初に書いてあるが
MTを指定するindex).それで、基底関数の集合は$\{F_i\}=\{F_{\bfq \bfG},F_{\bfq aLn}\}$と
書ける。APWの集合の指定に関しては、カットオフ$|\bfq+\bfG|<\EMAX$を用いる。
(デフォルトでない設定では$|\bfG|<\EMAX$という指定も可能)。

MTOに関しては、ある程度以上の占有数のある$l$については
2つのMTOを用いる。たとえば$l \le 3$で２つずつ用いるなら
原子あたり、$2\times\left(\sum_{l\leq 3}(2l+1)^2\right)=32$個のMTOを
用いることになる。さらには、local orbital (lo) \cite{lo} を、
いくつかの$al$チャンネルについて用いることにする。 
（原子によっては、``extended local orbital(elo)``を用いることもできるが、
最近はあまり使ってない。eloはMTOの一種であるが、
lo同様、局在性の高いorbitalを表現するために用いられる基底関数である）。
原子ごとにどのような局在基底を用いるかの指定のしかたはいまは単純になって
いる。構造ファイル（POSCARも読める）をあたえれば「ctrlgenM1.py」がデフォ
ルトの入力ファイルを自動生成するがそれに自動で設定されている。\\

\noindent{\bf smooth Hankel function(\smh)}:\\
The \smh\ function, as the envelop function of MTO, is first introduced
by Methfessel \cite{lmfchap,Bott98}. The spherical \smh\ function
$h_0(\bfr)$ (for $l=0$) is defined by the Helmholtz equation with a
gaussian source term $g_0(\bfr) = C \exp(-r^2/\RSM^2)$ (see Eq.(5) in
Ref.\cite{lmfchap}) instead of $\delta$-function;
\begin{equation}
(\nabla^2+\epsilon)h_0(\bfr) = -4 \pi g_0(\bfr),
\label{eq:defh0}
\end{equation}
where $C=1/(\sqrt{\pi} \RSM)^3$ is the normalization constant.
$\epsilon=-\kappa^2$ is the negative energy to specify the asymptotic
damping behavior of $h_0(\bfr)$.  At the limit $\RSM \to 0$ where
$g_0(\bfr)$ becomes $\delta$-function (as a point charge), $h_0(\bfr)$
becomes to the Hankel function $h_0(\bfr)=\exp(-\kappa r)/r$.  Since the
source term is smeared with the radius $\RSM$, we have no divergent
behavior at $r=0$ anymore; the \smh\ bends over at $\sim\RSM$ (See Fig.1
in Ref.\cite{lmfchap}).  From $h_0(\bfr)$, we can make
$h_L(\bfr)\equiv\YY_L(-\nabla) h_0(\bfr)$ for any $L$ with the spherical
polynomial $\YY_L(\bfr)=r^l Y_L(\hat{\bfr})$.  $Y_L(\hat{\bfr})$ is the
real spherical harmonics, where $\hat{\bfr}$ is the normalized
$\bfr$. $\YY_L(-\nabla)$ means to substitute $\bfr$ in $\YY_L(\bfr)$
with $-\nabla$. See Ref.\cite{Bott98} for details.\\

以上でわかるように、envelope
function $h_L(\bfr)$を与えるには、二つのパラメーター$\RSM$ and
$\epsilon$を指定する必要がある。これらは、$al$-dependentでありえるから
PMT法では、一般にはこれらは$\RSMal$および$\epsilon_{al}$と書け
($L\equiv(l,m)$), $m$ごとにenvelop関数のradial部分を変えることはしていない。
%実際、$\RSMal$ and $\epsilon_{al}$
%の決定の困難さがlmto法の問題点である。
%ガウシアンにおいても、基底の決定には
文献\cite{lmfchap}はこれらのパラメータの最適化について議論しているが、これは非常な難題である。
今の手法では、この最適化をさけて簡単な形でこれらのパラメータを与えている。
まず、すべてのMTに関して$\RSMa= R_a/2$ととることにする。
これにより、MTの外では、\smh は通常のHankel関数として振る舞うことになる。
$\epsilon$に関しては、$l$-independentなものを用いることにする。それで
各$aL$ごとの２つのMTOに対応して, $\epsilonaone$ and $\epsilonatwo$ 
を指定すればよい。実際に用いた値については最近では$l$によらずに
$\epsilon=-\kappa^2$を-1,-2Ryと取ることにしている。（APWのカットオフを３
から４Ryぐらいにすると、LDA・GGAの全エネルギーやバンドギャップが
$\epsilon$の選択にあまり依存しなくなる）。要するに「かなり局在性の高い
MTO」＋「かなり少ない平面波」で波動関数を表現することができている。
これは従来のMTO法にはなかった特徴である。$\epsilon=-\kappa^2$を0.1Ryなど
に取る必要があった。これではかなりの広がりをもつMTOとなってしまっていた。\\

\noindent{\bf one-center expansion}:\\
For the augmentation of the PW, that is, to determine the 2nd component
from PW as 0th component, we expand the PW within the MTs into the
Laguerre polynomial \cite{pmt1}.  Any function $f(\bfr)$ (PW in this
case) is expanded within a MT $|\bfr-\bfR_a|\leq R_a$ as
\begin{eqnarray}
&&f(\bfr)= \sum_{k,l} \CakL[f] \PakL(\bfr-\bfR_a), \label{onecenter1}\\
&&\PakL(\bfr)=\pakl(r) Y_L(\hbfr) \label{onecenter2},
\end{eqnarray}
where $k=0,1,2,...$ denotes the order of a polynomials $\pakl(r)$.  In
the case that $f(\bfr)$ is a PW, the coefficients for the function
$\CakL[f]$ are given analytically \cite{Bott98}.

When we use \smh\ centered at $\bfR_a$ as an envelope function
$f(\bfr)$, 
we have head part, which is $f(\bfr)=h_L(\bfr-\bfR_a)$ for
$|\bfr-\bfR_a| \leq R_a$, and tail part, which is in other MT
sites $|\bfr-\bfR_{a'}| \leq R_{a'}$.  As for the tail part, we use the
expansion of \req{onecenter1} as in the case of PW. On the other hand, we
use the head part as it is \cite{privatemark1};
% This is because it is not easy to expand the
% head part in such a expansion because of too steep nature of the funcion.
this can be taken into account in the formalism 
if the set $\{\PakL(\bfr) \}$ contains not only the Laguerre
polynomials but also $h_L(\bfr)$ as its members.\\

% In the followings, we apply this expansion not only to the PW, 
% but also to the \smh\ centered at $\bfR_a$.
% However, it is not easy to apply this expansion to the central MT of
% the \smh, that is, 
% this part is called as the head of the \smh.
% This is because it is too steep to be expanded 
% accurately with finite cutoffs in this series in practice.

%Here (b) and (c) are atom-centered localized orbitals, for which we
%take the Bloch sum to recover translational symmetry. 

\subsection{\bf ${P}_{akL}(\bfr)$の決め方:}
APWの場合\cite{soler89}では、envelope関数$F_{0i}(\bfr)$は平面波であり、
$F_{0i}(\bfr)$のMTサイトでの展開の$L$成分は、エネルギー$|\bfq+\bfG|^2$の球
ベッセル関数$\times Y_L$となる。lmfではこの球ベッセル関数を
ラゲール多項式を修正した関数系$p_{kl}(\gamma,r)$で展開している(ラゲール多項式の
引数に$r^2$を代入したものであり,\cite{Bott98}の12.15式あたりに詳細な説明
がある)。この$k$の範囲が$0\le k \le$KMXAとなる。

MTOではすこし複雑なことをしていてsmooth Hankelを
augmentするとき中心の原子におけるMT(Head Part MT)では
各$L$ごとに完全にradial partをくりぬくやり方でaugmentしている。
すなわち、このときには${P}_{akL}(\bfr)$として、smooth Hankelのonsite成
分そのものを使っていることになる。そのためkの数は一個ですむ。
またTail partのMTでは、上述の$p_{kl}(\gamma,r)$で展開している。
\cite{lmfchap}のp.11。\\


[$p_{kl}(\gamma,r)$での展開は再検討してもいいかもしれない。
これはbndfp.Fのhambl-augmbl.F-bstrux-pauggp
あたりに関係している。bndfpでよばれるhamblはハミルトニアンをつくるサブルー
チンであり、napwがAPWの数であり、kmaxがKMXA。とくに、（推定だが）問題になりそうなの
は、もとの平面波のMT内での絶対値の２乗和より、projectしたものの２乗和の
ほうが大きくなりうる点である。これはPAWでも起こりうるが、ノルムがマイナ
スになるような基底をあたえてしまう要因になりうる。]


\subsection{\bf $\tilde{P}_{akL} (\bfr)$の決め方:}
まず、各$a,l$に対してradial schoredinger eq.を
特定のエネルギーenu(もしくはそれに対応した対数微分であるP(pnu)で解く。
そのあと、それのエネルギー微分をつくる。これらがphi,phidot
($\phi_{al}(r),\dot{\phi}_{al}(r)$)である。
次に、それらの線形結合
$\tilde{P}_{akL}(\bfr)=(A\phi_{al}(r)+ B \dot{\phi}_{al}(r))\times Y_L$
を考える。この際、係数$A,B$は、MT端において
${P}_{akL}(\bfr)$と同じ値と微分値をもつように決定する。

Pの値はコンソール出力でptryで表示されている。
(一方、コンソール出力で表示されるebarは占有軌道の各lごとのDOSの重心位置。
現在のデフォルトはOPTIONS PFLOAT=1である。
古いバージョン（PFLOAT=0)ではバグがあった；過去とのcompatibilityのための
こしてある）。通常,ebarに対応するptryを計算しそれに対応したptryをpnewとする、
（コードではfp/pnunew.F L92;ebar =hbyl(m,isp,ib)/qbyl(m,isp,ib)参照）。
しかしそれでは不十分で、自由空間での対数微分の値(fp/pnunew.F;Free electron value)より深くなりす
ぎないという制約を課している；これは単純にはMT内でのポテンシャルが
上に凸であることを意味する。占有数が少なすぎるとき、
hybridyzationの影きょうで見かけ上そういうこと
（高い位置にあるべきenuが下がりすぎることが起こる）。

%In the one-body problem for given one-body potential $V(\bfr)$,
%we consider the eigenvalue problem with the Hamiltonian and overlap matrix 
%$\langle F_i| -\frac{\nabla^2}{2m} |F_j \rangle $ and 
%$\langle F_i| F_j \rangle $. However, this procedure contains complicated
%cross terms. Instead of this procedure, we consider another type of one-body problem
%explained in the following.

$\tilde{P}_{akL}(\bfr)$は、phi,phidotという関数で表現されており、
self-cosnsitencyへ達するitetationにおいて更新されていくのがデフォルトだ
が、固定することも出来る(FRZWFオプション,IDMOD=1、将来的には原子で計算し
たphi,phidotに固定したほうが系統的誤差を減らせる可能性がある)。\\

After specifying $\{\PakL(\bfr) \}$, we can determine corresponding
$\{\wPakL(\bfr) \}$ as a linear combination of
$\phi_{al}(r)Y_L(\hat{\bfr})$ and $\phidot_{al}(r)Y_L(\hat{\bfr})$,
where partial waves $\phi_{al}(r)$ and its energy derivatives
$\phidot_{al}(r)$ are given as the solutions of the radial Schr\"odinger
equation for the spherically-averaged potential of $V_{1,a}$ in
\req{eq:v}, where energies $E_{al}$ to solve the equation are given as
the center of gravities of the occupied states of the partial density of
states of the $al$ component; thus 
$\phi(r)$ and $\phidot(r)$ are not with the subscripts $aL$ but with $al$.
This prescription to determine $\{\wPakL(\bfr) \}$ can be taken as a
quasi-minimization procedure, from the view of total energy
minimization.

As for the $al$ with Lo, we need another partial wave $\phi^{\rm
Lo}_{al}(r)$ corresponding to Lo.  When the Lo is to describe a deeper
level, we can set the energy to solve the radial Schr\"odinger equation
$E^{\rm Lo}_{al}$ at the center of gravity; then we set $E_{al}$ at the
Fermi energy instead of the prescription in the previous paragraph.

The number of basis is simply specified by the cutoff energy of the APW
for (a). However, specification of MTOs (b) is not so simple.  
We use multiple MTOs for each $aL$ to reduce the number of basis with 
keeping the computational accuracy \cite{pmt1}.
Since $h_L(\bfr)$ as the envelope functions are specified 
by the parameters $\RSM$ and $\epsilon$, we have to specify them for
all MTOs. Ref.\cite{lmfchap} discussed optimization of them so as
to minimize the total energy. However, as seen in figures in
Ref.\cite{lmfchap}, such non-linear optimization is too complicated.
%In fact, most serious problem in the full-potential LMTO method is in the
%difficulty to optimize $\RSM$ and $\epsilon$.
Thus it is necessary to give a method to set the parameters 
in a simple manner as follows. 
As for $\RSM$, we can use a condition $\RSM= R_a/2$ for all MTOs. 
Then the envelope functions out side of MTs well coincide with
the usual Hankel function. 
Even with this simple setting of $\RSM$ without optimization,
numerical accuracy can be kept well; we can check the
convergence of calculations with the number of APWs.
We also see the dependence on $\epsilon$'s are rather small
in the PMT method. The dependence becomes less when we use larger
number of APWs; hence we do not need to stick to careful choice of
the parameter $\epsilon$.
Thus the serious problem of the full-potential LMTO method, ``how
to choose MTO parameters'' are essentially removed in the PMT
method. This is numerically detailed in the paper which gives results for
diatomic molecules from H$_2$ through Kr$_2$ \cite{kotani_linearized_2013}.

We use one further approximation. In \req{eq:n}, we make angular-momentum cutoff.
Even though we have angular momentum component up to 
$2\times l_{{\rm max},a}$ in the 1st and 2nd components in \req{eq:n}, 
we drop components higher than $l_{{\rm max},a}$; 
it is meaningless to take them into account since we have already make 
truncations for eigenfunctions. Note that this does not affects $O_{ij}$
and $T_{ij}$ because only the special components determine them.

----\\
NULL基底が生じること：\\
一つ注意すべき点は、このphi, phidotによるaugmentationはnull基底を生じ
せしめることである。すなわち、PAWとちがって、$k$の自由度
(\req{onecenter1}におけるradial関数の数)は、phi,phidotの数の
２よりも大きいので（通常(k=0,1,...,KMXA=5)と6程度に取る）、
異なる$\CakL[f]$をもつ$f$をaugmentした結果、同じphi,phidotの係数を得るこ
ともありえる。差をとることを考えれば、augmentしてphi,phidotの係数がゼロ
になることがおきたとしても、それに対応する$f$がゼロではないという基底が
まざりうるということである。これはヌルベクトル
である；すなわち、第0成分＝第2成分がMT内部に局在して第1成分がゼロという
関数が基底に含まれることになる（これは物理的に意味をもたない）。
これが「overcompleteness」が起こる要因である（のひとつである）と思われる。\\


また、内積の正定値性の問題がある。
3-component spaceの内積は、\req{eq:norm}で与えられているという
問題がある。この内積は負符号部分を含むのでその固有値は-1から１までとなる。
きちんと（A）条件(すなわち第０成分のMT内成分が第２成分と一致する)が満た
されていない場合、一般にはたとえば、(1,1,0,5)＋(-1,-1,0.5)のノルムが
マイナスになるというようなことが起こり得る（これは3成分を単純に数字で表して考えてみた例）。
pwemaxを大きくするとき、kmxaをおおきくしないといけない、というような点に
この問題が現れているようにも思える。\\

実際の計算において、収束が破綻するとき第0成分＝第2成分が数値的に
やたらと大きくなるという状況があった。これは、本質的にこれらの成分が不定
であるという点に問題があると思える。対角化を行うとき第2成分ができるだけ
小さくなるように、人為的に、ポテンシャルを加えてやるという工夫が考えられ
る。実際のところ、計算の破綻が起きやすいのは、LaやNaなどでMT半径を大きく取っ
た場合である。sp電子が低エネルギーの平面波で表せてしまうので、、ヌルベク
トルが見えてしまう。これを高いエネルギーのところに飛ばしてしまう必要があ
る（単純に自由度を引き抜くようなやり方ではどうも系統性をこわしてしまって
よろしくないようだ）。

PMT法である程度以上に平面波数を増やすと線形独立性の問題で計算が破綻する。
凝縮性の高い固体では４Ry程度が目安である。
その場合、まずはmixing parameterのb=を0.2程度に小さくしてみるとうまく
行く場合がある。またKMXAを大きくとると計算が安定する場合もある。
また「MT半径を小さくする」と計算が安定する。ただし、
frozen coreのspiloutが大きくなり計算の信頼性が減る場合もある（この時には、
coreをloで扱う必要もありえる。そうすることでMT半径をかなり小さくとること
もできる）。およそ、アルカリ、アルカリ土類などの原子半径を小さめにとるべきである。
とにかくこのような原子のSのMTOは容易に低エネルギーのAPWで作られてしまうために
計算が破綻しやすい。実際、それらのMTOを抜くと計算が安定したりもする。


\subsection{離散化における全エネルギーの定義}
ーーーこのsubsectionは古くなっている可能性ありーーー\\
計算機においては有限の変数（離散化）により全エネルギーを表現することが
必要である。
%すなわち「離散化された変数による全エネルギーの表現」を
%きちんと定義しておくことを確認しておくことが必要である。
そして、そのエネルギーを最小化することで全エネルギーを決定することができ
る。すなわち、Kohn-Sham方程式を出してから離散化するのではなく、
全エネルギーを離散化表示してから、離散化されたKohn-Sham方程式を導出する
のである。これにより、全エネルギーとそれの微分であるハミルトニアンとの整
合性がきちんと保たれることになる
（打ち切り誤差がなければ厳密にその関係性が満たされる）。

このことを全エネルギー\req{eq:etot}において確認し、どれだけの離散化
パラメーターが出てくるのかを概観する.このとき、radial方向の積分に関して
は離散化誤差は無視する；この離散化は、計算速度にあまり影響せず
十分に細かくとれるからである。
まず、周期境界条件により、波動関数は1stBZ中の波数$\bfk$をもつことになる。
1stBZを格子で切り分け格子点の上でのみの$\bfk$点を考えるようにする。
それで、envelope関数$F_{0i}$のindex $i$は、この離散化された$\bfk$の
値を含む複合indexとなる。

envelope関数$\{F_{0i}\}$は、「平面波(波数$\bfk+\bfG$で指定される)」
と「smooth Hankel関数をBloch sumして$\bfk$を持つようにしたもの
（さらには、原子位置、角運動量、およびsmooth Hankelのdamping因子EHと
smoothing radius RSMHで指定される。）」を含んでいる。
これらをaugmentするときの係数$C^i_{akL}$と$P_{akL}$は、
augmentationの処方箋を決めれば決定される。現在、この処方箋は、
\cite{Bott98}にある手法xxxで行われている。augmentationに関しては、
$k$のカットオフKMXA,$L$のカットオフLMXAが必要となる。
$\tilde{P}_{akL}$は、$\phi_l(r),\phidot_l(r)$という二つの
radial関数をもちいて組み立てられる。これらは、onsiteでの$V_{1,a}$の
球対称部分)を用いてradial schrodinge eq.を適当なエネルギー
$\epsilon_{al}$（enuと表示されたりする）で解くことで得られる。
この方法は、全エネルギー最小化に関しておおむねの最適化''
になっていると言えるが、\req{eq:eigenp}の一体ハミルトニアンを通じての
全エネルギー最小化の方程式（Kohn-Sham方程式）とは別である。
これは基底を固定したとして、それの係数を調整して全エネルギーを最小化する
方程式である。
%$\phi_l(r),\phidot_l(r)$を表現する
%ためのradial方向のメッシュは十分に小さくとれるのでその点における離散化誤
%差は無視できることにも注意しておく。

その基底関数をもちいて、運動エネルギーの行列要素\req{eq:kin}を計算することができ
る。この式の第0成分はenvelop関数にのみ関係しており、その運動エネルギー行
列要素は解析的に計算できる
（コードでは,bndfp-hambl-smhsbl-hhibl,hhibl内。smooth Hankelの積やそれ
をLaplacianではさんだものの積分がsmooth Hankelで書けること---\cite{Bott98}の
(10.10),(10.12)など---を利用してこれを計算している).
第1,第2成分に関しても上述の$C^i_{jkL},{P}_{akL},\tilde{P}_{akL}$から計算
できる。

次に$E_{\rm es}+E_{\rm xc}$を評価することを考える。
それらの第1,2成分については、radialな積分に帰着できるので、運動エネルギー
の時と同様に$C^i_{jkL},{P}_{akL},\tilde{P}_{akL}$から計算できる。

つぎに、それらの第0成分について考える。
このためには、envelope関数（smooth Hankelと平面波）を、
実空間メッシュ（実空間でのユニットセルを等間隔で分割したもの）の上で表現
したものを考える必要がある（コード内では,bndfp-addrbl-rsibl-rsibl1,rsiblpで、
固有関数の実空間メッシュのうえでの値を直接に生成している）。
そして、それの積により電子密度smrhoをrsibl2で作っている(このsmrhoが
bndfp.Fに返されmkpotに渡されてポテンシャルの生成に使われる)；
電子密度は実空間メッシュの上での値で与えられるわけである。
これをFFTすると電子密度は$\bfG$で展開して表現されていることになる。
$E_{\rm es}$の評価には、この表現を用いる。coreからの寄与や多重極変換にか
らんで、$\nzcv$には、smooth HankelやGaussianを含むがこれらに
関係する部分は解析的に取り扱う(mkpot-smvesのコメントは、参考になる。しか
し、本書の方が正確である---coreのsmooth Hankelによる寄与が適当に省略されて書かれている）。
また、$E_{\rm xc}$の第0成分の評価においては、実空間メッシュの上で交換相関エネ
ルギーを求めてそれを積分することをおこなう(mkpot-smvxcm. mkpot-smvxc2はvalence
のみに関する量を計算している.mkpot-smvxc2はおそらくvalenceのみの寄与を表示するこ
とのみに必要で、sc計算には不要)。\\

以上で、全エネルギー$E$が計算機においてどのように表現されているかを与え
た。これらを考え合わせると、けっきょく、全エネルギーが、$\rho_{ij}$の汎関数で与
えられることになる。$\rho_{ij}$は、この全エネルギーを最小にするように決定される。
それで、これを調整してエネルギーを最小化する問題になる。
{\small 注意：金属の場合は、$\rho_{ij}$の汎関数というよりも,それを生成す
る$H_{ij}$（あるいはポテンシャルの）汎関数と考えるほうがよい。
まず$H_{ij}$が与えられれば、BZ内の積分も考慮した形で$\rho_{ij}$が与えら
れる(離散的な$\bfk$点でtetrahedron法をもちいる)。
これを用いて全エネルギーが計算される。
一般的に言っても、密度の汎関数というよりそれを生成するポテンシャルの汎関数と
して考察したほうが便利な場合も多い。}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{problems in the PMT method}
\label{sec:problems}
Let us examine three problems of the PMT methods, and ways to
manage them.

The first problem is the positive definiteness of $O_{ij}$.
Since the last term in \req{eq:norm} can give negative contribution,
there is a possibility that $O_{ij}$ can not be positive definite.
In principle, we can expect almost zero eigenvalues on the matrix
$\intaa d^3r \left(F^*_{0i}(\bfr)F_{0j}(\bfr)-F^*_{2i,a}(\bfr)F_{2j,a}(\bfr)\right)$ 
for all MTs if the truncation parameters are large enough. 
This guarantees the positive definiteness of $O_{ij}$.
In practice, we typically use $k_{{\rm max},a} \sim 5$ 
and $l_{{\rm max},a}\sim 4$; they
can give satisfactory results with keeping positive
definiteness of $O_{ij}$, as seen in Refs.\cite{pmt1,kotani_linearized_2013}.

The second is the undefiniteness of the second component $\psi_{2p}$.
This is clear if (A) is satisfied; as $\psi_{2p}$ within MTs is not uniquely
determined since it is canceled completely by $\psi_{0p}$ within MTs.
However, since we use (A') in practice, this can cause numerical instability.
To illustrate this, let us consider a linear combination of basis functions
where only their 0th and 2nd components within MT are non zero.
This is a null vector which has no physical meanings; it gives zero when 
we apply Hamiltonian and Overlap matrix to it. This is a kind of ghost. 
Apparently, this occurs because the 3-component space is not a complete
metric space in the mathematical sense.
When we enlarge number of basis, this null vector can cause numerical problems.
It can be an origin of uncontrollable eigenvalue (e.g, 0 divided by 0), or
it can attach to some eigenfunctions and deform them easily.
In fact, we observed unconverged cases when the 2nd component of
electron density becomes too large. 
Within our current implementation of the PMT, we should use limited number
of basis so as to avoid this problem. However, in Refs.\cite{pmt1,kotani_linearized_2013},
we can see enough stability on the total energy convergence before such problems occurs
when we increase the number of basis .

It will be possible to remove such undefiniteness in some manners.
For example, we can minimize the total energy with adding a 
fixing term $+\lambda \sum_p \intaa d^3r
\psi^*_{2p,a}(\bfr)(1-\tilde{P})\psi_{2p,a}(\bfr)$, 
where $\lambda$ is a Lagrange multiplier, $\tilde{P}$ is a projector to
the space spanned by some pseudo partial waves corresponding to true
atomic partial waves. If $\lambda$ is infinite,
2nd components are only spanned by the pseudo partial waves.
However, we should avoid a large $\lambda$ so as not to 
deteriorate the total energy minimization.

The third problem is the orthogonality to the cores. 
In the frozen core approximation in \refsec{sec:frozencore}, 
we take account of the spillout of the core electron density 
from MTs; this allows us to use a small MT radius.
However, when we use quite small MTs, we observed a problem of orthogonality
of wavefunctions to the cores, resulting in unconvergence. In such a case, 
we  need to introduce local orbitals to represent cores so as to keep
the orthogonality. It may be possible to enforce the orthogonality 
with a projector as described in Ref.\cite{PAW}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5
\subsection{comparison with PAW}
\label{sec:comparison}
Here we will make a comparison of the PMT method with the PAW method
\cite{PAW,kresse99} based on the 3-component formalism.

In the PAW method, we perform the all-electron (AE) 
calculations for a spherical atom as a reference in advance.
Then the main problem is how to solve the one-body problem
for a given one-body potential $V(\bfr)$ in real space. 
As in \refsec{aug3}, the problem is translated into the problem in the 3-component space
for $V=V_0\oplus V_1 \ominus V_2$.
For simplicity, we omit the index $a$ in the followings.

The basis set in the PAW is given as follows.
We first prepare AE partial waves
$\{\phi_i(\bfr)\}$ (e.g, two for each $aL$ in Ref.\cite{kresse99}),
as solutions of radial Sch\"odinger eq. for $V_1$ at some reference 
energies $\{\epsilon_i\}$ (in this section, the index $i$ is for the
partial wave). Then we set up corresponding
pseudo partial waves $\{\tilde{\phi}_i(\bfr)\}$.
The eigenfunction $\psi$ in the PAW can be represented 
in the 3-component space; for given 0th-component $\bar{\psi}$
(this is called as {\it pseudo wavefunction}), we have
$\psi$ with projectors $\{\tilde{p}_i\}$ as
\begin{eqnarray}
\psi=\bar{\psi}
\oplus \sum_i |\phi_i\rangle \langle \tilde{p}_i|\bar{\psi}\rangle
\ominus \sum_i |\tilde{\phi}_i \rangle \langle
\tilde{p}_i|\bar{\psi}\rangle.
\label{eq:psibar}
\end{eqnarray}
Here $\tilde{p}_i$ should satisfy
$\langle \tilde{p}_i|\tilde{\phi}_j \rangle=\delta_{ij}$.
The minimization of the total energy of the one-body problem 
$E= \sum_j^{\rm occupied} \psi_j^* \cdot (T+V) \cdot \psi_j$
with respect to $\bar{\psi}_j$ is given by
\begin{widetext}
\begin{eqnarray}
&&\left( \frac{-\nabla^2}{2m}+V_0(\bfr)-\epsilon_j +
 \sum_{ii'}  
  |\tilde{p}_i \rangle  
   \left(dH_{ii'}-\epsilon_j dO_{ii'} \right)  
  \langle \tilde{p}_{i'}| 
\right) \bar{\psi}_j=0, \label{eq:seqpsibar}\\
&&dH_{ii'}= \langle \phi_i| \frac{-\nabla^2}{2m}+V_1|\phi_{i'}\rangle  
 -  \langle \tphi_i| \frac{-\nabla^2}{2m}+V_2|\tphi_{i'}\rangle \\
&&dO_{ii'}= \langle \phi_i|\phi_{i'}\rangle  
 -  \langle \tphi_i| \tphi_{i'}\rangle.
\end{eqnarray}
If we use infinite number of partial waves which makes a complete set, 
\req{eq:seqpsibar} reproduces the original one-body problem in real space.
% since 0th-components within MT
%completely cancels 2nd component because of 
%$1=\sum_{i}|\bar{\phi}_i\rangle \langle \tilde{p}_i|$;
%here we need to assume completness of $\{\phi_i\}$ also.

Let us consider a case where
$\psi_j=\bar{\psi}_j \oplus \phi_j\ominus\tphi_j$
is the solution of \req{eq:seqpsibar} with eigenvalue $\epsilon_j$,
where $\bar{\psi}_j$ within MT coincides with $\tphi_j$.
This is given by \req{eq:psibar} from $\bar{\psi}_j$.
When we make a truncation for the number of partial waves,
$\{\tilde{p}_i\}$ should satisfy 
\begin{eqnarray}
&& \left( \frac{-\nabla^2}{2m}+V_0(\bfr)-\epsilon_j \right)|\tphi_j \rangle
 + \sum_i |\tilde{p}_i \rangle  
   \left(dH_{ij}-\epsilon_j dO_{ij} \right)  =0, \label{eq:condproj}
\end{eqnarray}
\end{widetext}
in order to satisfy \req{eq:seqpsibar}.
This determines $\{\tilde{p}_i\}$; this is one of the main idea in the PAW method. 
In practice, considering the numerical stability, 
we determine  $\tilde{p}_i$ so that \req{eq:condproj} is approximately
satisfied \cite{PAW}. 

Another important idea of the PAW is the introduction of the
pseudopotential. This is how to determine $V_0$ within MT ($=V_2$).
This is because the result strongly depends on the pseudopotential
when the number of partial waves are small. In principle, the pseudopotential 
should be determined so that $\bar{\psi}_j$ contain high energy part 
(high angular momentum $l$ or highly oscillating part) of the wavefunctions
which is missing in the 1st and 2nd components due to the 
truncation of the number of partial waves.

Note that the truncation can cause the ghost state problem in the PAW method.
To illustrate this, consider a case that $s$ wave part in MT is described
only by two partial waves $2s$ and $3s$. Then the PAW procedure maps $\bar{\psi}$ with zero node to 
$\psi$ with one node, $\bar{\psi}$ with one node to $\psi$ with two nodes. 
Problem is that $\bar{\psi}$ with two nodes, which is orthogonal to $\{\bar{\psi}_i\}$ for $2s$ and $3s$,
can not be mapped to $\psi$ with three nodes due to the truncation. 
Thus it is possible that such a function cause a ghost state;
we have to design the pseudopotential so that such $\bar{\psi}$ should be
kept to be at a high enough energy region (to push $\bar{\psi}$ high away from the
Fermi energy, it may be better to use relatively strongly repulsive pseudopotential). 
Ref.\cite{kresse99} claims that there is no
ghost state for all kinds of atoms. However, it is not easy
to check the convergence within the framework of the PAW method.

In the PAW method with PWs proposed in Ref.\cite{kresse99}, many PWs are required
compared with with LAPW. Roughly speaking, energy cutoff of PWs are
$\sim$15Ry in LAPW, and $\sim$30Ry in PAW \cite{filippi94,kresse99}.
This is because the PAW method, as is the case of pseudopotential methods,
needs to uniquely determine the pseudo partial waves (0th component) within MT.
This is in contrast with the LAPW (and the PMT) method, 
where 0th component within MT is irrelevant because 
the 2nd components have enough degree of freedom to well cancel its contribution.
However, with sacrificing the cutoff energy,
the PAW takes robust convergence that comes from the absence of the 
null vector problem discussed in \refsec{sec:problems}

As a theoretical possibility, we can imagine a method to 
use \smhs\ together with the PWs in the basis set
for the one-body problem in the PAW method.
However, it is not very clear whether it becomes 
a efficient method or not. To reduce the number of basis of PWs, it is
necessary to make the \smhs\ span high-energy parts of pseudo
wavefunctions. Thus we have to tailor \smh\ so that it fits to the pseudo
wavefunctions not only interstitial region, but also within MT. 
This can be not straightforward.


\section{summary for PMT}
We have reformulated the PMT method on the basis of the 3-component
formalism, which is a generalized version of the additive augmentation 
given by Soler and Williams. The 3-component formalism
allows including any kinds of basis not necessarily given by a
projector as PAW. This fits the procedure to give the Kohn-Sham equation for a mixed basis method such 
as the PMT method from the total energy minimization scheme; this
results in the transparent derivation of the atomic forces.
We believe that the formalism shown here could give a basis for future developments.
Our results for molecules from H$_2$ through Kr$_2$ 
with several new developments on the PMT method 
is given elsewhere \cite{kotani_linearized_2013}.

\newpage
\begin{widetext}
 \hrule width 18cm
\end{widetext}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{PMT-QSGW Implementation}
\label{sec:impl}

%xxx3101
%kotani2 これはintroductionより移動,修正。
In Sec.~\ref{sec:ov}, we show overview of the method to perform
the $GW$ calculation. We made some improvements to the method in
Refs.\onlinecite{kotani_all-electron_2002,kotani_quasiparticle_2007},
where we take some ideas from another $GW$ implementation 
given by Friedrich, Bl\"ugel, and Schindlmayr
\cite{friedrich_efficient_2010}.

In Sec.~\ref{sec:kint}, we show new improvement to the offset-$\Gamma$ method, which is
in order to treat $\bfk \to 0$ divergence of integrand for the self-energy calculation.
This improvement can correctly capture anisotropy of the screened Coulomb interaction,
although the previous offset-$\Gamma$ method in FP-LMTO-QSGW \cite{kotani_quasiparticle_2007}
is dangerous to treat anisotropic systems.

In Sec.~\ref{sec:siginterp}, we explain the interpolation of 
$\vxc_\bfk(\bfr,\bfr')$. The interpolation procedure
is simplified in comparison with that used in FP-LMTO-QSGW.

\subsection{overview}
\label{sec:ov}
%xxx3001
%kino1 MTOは既出
%kotani2 「MTOは既出」はちょっと意味がわからないです。
In the PMT method \cite{kotani_fusion_2010}, 
the valence eigenfunctions for given $\H0$ are represented
in the linear combinations of the Bloch summed MTOs
$\chi^{\bfk}_{\brl{j}}({\bf r})$ and the APWs $\chi^{\bfk}_\bfG (\bfr)$;
\begin{eqnarray}
\label{eq:lmtopsi}
\Psikn(\bfr) = \sum_{\brl{j}} z^{{\bfk}n}_{\brl{j}}
\chi^{\bfk}_{\brl{j}}({\bfr})+ \sum_{\bfG} z^{\bfk n}_{\bfG}
\chi^{\bfk}_\bfG(\bfr),
\label{eqeigen}
\end{eqnarray}
where we use indexes of wave vector $\bfk$, band index $n$, 
reciprocal lattice vector $\bfG$. The MTOs in the primitive cell are 
specified by index of MT site $\bfR$, angular momentum $L=(l,m)$, and
$j$ for radial functions. 
%xxx3002
%kino1 基本的には後方参照してはいけない。
%kino1 ここはcoreのexchangeだけvalenceと別に、しかしvalenceと同じmanner
%で計算できると言っていますか？
%kotani2 その意図です。core1のみです（core1でMendeleyで検索）。
%kotani2 ややこしいので単純にしました。
% Core eigenfunctions restricted within MTs 
% can be also represented in \req{eqeigen}, but without summation 
% as to $\bfR$, $L$, $j$ and $\bfG$, 
% the following treatment is applicable; we take into account
% only the exchange part (in \req{eq:sigx} appeared later) as the
% contribution from cores.
As for core eigenfunctions, we calculate them in the condition
that they are restricted within MTs.
%We use core eigenfuncitons which are restricted within MTs.
Then we consider contributions of the cores only to the exchange part 
defined in \req{eq:sigx} in the followings. 
(In other words, we apply core1 treatment in 
Ref.\onlinecite{kotani_quasiparticle_2007} for all cores.)

In Ref.\onlinecite{kotani_fusion_2010}, we have tested variety
of basis sets of MTOs with APWs, whose numbers are specified by
the APW cutoff energy $\EMAX$. 
Then we show a simple and systematic procedure 
to choose the MTO basis sets in Ref.\onlinecite{kotani_linearized_2013}.
With the procedure, we can perform 
stable and accurate calculations. 
In the procedure, we use a large set of MTOs 
(two or three MTOs per $L$ for valence electrons) together with APWs 
with rather low cutoff energy, typically, $\sim$4 Ry.
Thanks to the APWs, we can include only highly localized MTOs.
For the damping factors $\propto \exp(- \kappa r)$ contained in MTOs,
we use $\kappa^2=$ 1.0 and 2.0 (bohr)$^{-2}$. 
In Ref.\onlinecite{kotani_linearized_2013}, we have shown that it is not necessary 
to optimize the $\kappa$ parameters when we use large enough $\EMAX$ ($\sim$4 Ry)
as shown in Fig.1 of Ref.\onlinecite{kotani_linearized_2013}.
Other parameters to specify MTOs are also fixed in a simple manner.
The smoothing radii of the smooth Hankel functions, which
are the envelope function of the MTOs, are set to be one half of the MT radii.
Thus the MTOs are chosen essentially automatically, and
the convergence is checked only by $\EMAX$.
In addition, we do not need to use ESs because APWs is substituted for the MTO basis of ESs.
%Thus, with the PMT method, we are free from problems of FP-LMTO method: 
%how to choose parameters to set MTOs; how to set empty spheres.
We have shown that such basis set works well in practice 
to determine the atomization 
energies of homonuclear dimers from H$_2$ through Kr$_2$ with the
convergence of chemical accuracy $\sim$ 1 Kcal/mol or less
in the DF calculation in the PBE exchange correlation functional in a large supercell
\cite{kotani_fusion_2010}. Note that such supercell calculations are 
tough tests for augmented wave methods (FP-LAPW requires very
high $\EMAX$ because of small MT radius; 
%xxx3003
%kino1 下は言い過ぎでしょう。
%kotani2 it is not easy にしました。
%kotani FP-LMTO is essentially not applicable because of no way to fill ESs).
it is not easy to apply FP-LMTO because of no way to fill ESs).
In comparison with methods only using the localized basis set
such as \texttt{Gaussian} in quantum chemistry,
the PMT method is advantageous in the point that it can describe
scattering states (higher than zero level) accurately.

%xxx3102
%kotani2 ここにあったパラグラフ削除。SigmaのinterpolationをMTOでおこなう
%話。情報はこのサブセクションの最後へ。あるいは、この章の冒頭部分へ（Bluegel論文の引用部分）。

At first, we re-expand $\Psikn(\bfr)$ in \req{eq:lmtopsi}  
as a sum of the augmentation parts in the MTs and the
PW parts in the interstitial region.
\begin{eqnarray}
\Psikn(\bfr)
= \sum_{\bfR u}  \alpha^{{\bfk}n}_{\bfR u} \varphi^{\bf k}_{\bfR u}({\bf r})
 + \sum_{\bf G}  \beta^{{\bfk}n}_{\bf G} P^{\bf k}_{\bf G}({\bf r}),
\label{def:psiexp}
\end{eqnarray}
where the interstitial plane wave (IPW) is defined as
\begin{eqnarray}
P^{\bf k}_{\bf G}({\bf r}) =
\begin{cases}
 0                           & \text{if {\bf r}} \in \text{any MT} \\
\exp (i ({\bf k+G})\cdot{\bf r}) & \text{otherwise}
\end{cases}
\end{eqnarray}
and $\varphi^{\bf k}_{R u}(\bfr)$ are Bloch sums of the atomic functions
$\varphi_{R u}(\bfr)$ defined within the MT at $R$,
\begin{eqnarray}
\varphi^{\bf k}_{R u}({\bf r}) &\equiv& \sum_{\bf T} \varphi_{R u}({\bf
 r-R-T}) \exp(i {\bf k\cdot{}T}).
\label{eq:blochsum}
\end{eqnarray}
{\bf T} and {\bf G} are lattice translation vectors in real and reciprocal
space, respectively. 

-------------------------\\
$\varphi_{Ru}(\bfr)$は、MTサイトR内でのみnon zeroな関数
であり、uは、複合indexで「角運動量$L$,動径部分の区別の
index（phi,phidot,phizなどとプログラム内では呼ぶ）」である。
また、GW計算においてはコアは、MT内にあるものとして扱われる（ctrlでLFOCA＝１にしておいてもLFOCA=0で再計算して用いられる）。
コア波動関数も上述のブロッホ和の形\req{eq:blochsum}で与えられている。

\noindent{\bf データファイル読み込みルーチン:}
\begin{itemize}
\item 
readeval:固有値読み込みルーチン
\item
readcphi: $\alpha^{{\bfk}n}_{Ru}$の読み込み
\item
readgeig: $\beta^{{\bfk}n}_{\bf G}$の読み込み
\item:
readngmx,readqg: ${\bf G}$の読み込み。
\end{itemize}
readevalなどを用いるには、init\_readeigen,init2\_reaeigenを先に呼ぶ必要
がある（これらはメインルーチンの中に書かないで一度目の呼び出しのときに。
すべてのファイルをランダムアクセスファイルにしたほうがいいような気もして
いる。メモリの制約で、少し大きいシステムになってくるとKeepEigen
offをGWinputでセットしないと走らない場合もある(現状のコードでは有効でな
いかも。とにかくメモリがきちんと節約できていないかもしれない。)
データへのアクセスは{\bf q}などを与えて直接に呼び出せるようにしている。
とにかく、あるプログラム（たとえばhx0fp0\_sc)を走らせるとき、それ以前に作ら
れ、ファイルに格納されたデータの（十分に高速な）読み出しが必要になる。
%これを、read*という名前のルーチンで行えるよう統一したい。
%書き出しに関しては、直接ファイルオープンして書き出させたほうが見やすい場
%合もあるが、write*と言う名前のルーチンを対にしてモジュールに収めたほうがいいかもしれない。
データを二重に持たせているような部分は極力排除したい。\\
--------------------------------\\

In the $GW$ calculation, we need not only the basis set for
eigenfunctions, but also the basis set to expand the product of eigenfunctions.
The basis is called as the mixed product basis (MPB) $\{M^{\bf k}_I({\bf r}) \}$
first introduced in Ref.\cite{kotani_all-electron_2002}.
The MPB 
consists of the product basis (PB) within MTs \cite{aryasetiawan_product-basis_1994}
and the IPW in the interstitial region.
Since $\{M^{\bf k}_I({\bf r}) \}$ contains IPWs which are not orthogonal,
we define dual for $\{M^{\bf k}_I({\bf r}) \}$ as
\begin{eqnarray}
&& |\tilde{M}^{\bf k}_{I} \rangle \equiv \sum_{I'}
   |M^{\bf k}_{I'} \rangle (O^{\bf k})^{-1}_{I'I} \, , \\
&& O^{\bf k}_{I'I} = \langle M^{\bf k}_{I'} |  M^{\bf k}_I \rangle.
\end{eqnarray}
%xxx3004
%kino1  H = E S : generalized eigenvalue problem
%kotani2 OK。わかりやすいようセンテンス分割。
From $v_{IJ}^\bfk= \langle M^{\bf k}_{I} |v|  M^{\bf k}_J \rangle$,  
we calculate eigenfunction for the generalized eigenvalue problem defined by
$\sum_J (v_{IJ}^\bfk - v^\bfk_\mu O^{\bfk}_{IJ} ) w_{\mu J}^\bfk = 0$ where
$v_\mu(\bfk)$ are the eigenvalues of the Coulomb interaction matrix.
Then we have the Coulomb interaction represented by matrix elements as 
\begin{eqnarray}
v(\bfk)=\sum_{\mu} | E^{\bfk}_\mu \rangle {v_\mu(\bfk)} 
\langle E^{\bfk}_\mu |,
\label{eqvcoue}
\end{eqnarray}
where we define a new MPB 
$|E^{\bf k}_\mu({\bf r})\rangle=\sum_J |M^\bfk_J\rangle w^\bfk_{\mu J}$ 
which is orthonormal and is diagonal to the Coulomb interaction $v(\bfk)$. 
For the all-electron full-potential $GW$ approximation,
\req{eqvcoue} is introduced in Ref.\onlinecite{friedrich_efficient_2010}.
This corresponds to the representation in the plane wave expansion 
$v(\bfk+\bfG,\bfk+\bfG')=\frac{4 \pi \delta_{\bfG \bfG'}}{|\bfk+\bfG|^2}$.
%kino1 Here $v_\mu(\bfk)$ are the eigenvalues of the Coulomb interaction matrix. 上へ移動。
%kino1 $\mu=1$ corresponds to the largest eigenvalue of the matrix, that is,
%kino1 $v_{\mu=1}(\bfk)\sim \frac{4 \pi e^2}{|\bfk|^2}$.
%kino1 mu=1がlargestである情報は二度と使わない。
%kino1 修正The largest eigenvalue of $v_{\mu=1}$ is $\sim \frac{4 \pi e^2}{|\bfk|^2}$.
%kino1 後ろで使いますね。
$\mu=1$ corresponds to the largest eigenvalue of $v_{\mu}$, and 
$v_{\mu=1}$ is $\sim \frac{4 \pi e^2}{|\bfk|^2}$, which is related to 
the divergent term discussed in Sec.\ref{sec:kint}.
%kotani2 ーーーーーーーーーさわらないでよい


\begin{widetext}
With the definition of 
$\langle A| B\rangle =\int d^3r A^*(\bfr) B(\bfr)$,
the exchange part of $\Sigma(\omega)$ is written as
\begin{eqnarray}
\Sigma^{\rm x}_{nm}(\bfq)=
\langle \Psiqn|\Sigma_{\rm x} |\Psiqm \rangle
&&=-\sum^{\rm BZ}_{{\bf k}}  \sum^{\rm  occ}_{n'}
\langle \Psiqn| \Psi_{{\bf q-k}n'} E_\mu^{\bf k} \rangle
v_{\mu}({\bf k})
\langle E_\mu^\bfk \Psi_{{\bf q-k}n'} | \Psiqm \rangle.
\label{eq:sigx}
\end{eqnarray}
%We evaluate integral on $\bfk$ by a discrete sum on the regular mesh points
%including $\bfk=0$. However, we need to replace divergent
%$v_{\mu=1}(\bfk=0)$ with an effective one $\overline{v_{\mu=1}}(\bfk=0)$
%as explained in Sec.~\ref{sec:kint}.

The screened Coulomb interaction $W(\omega)$ is calculated
through \req{eq:defw}, where the polarization function $\Pi(\omega)$
is written as
%xxx
%kino1  < Psi | Psi E > の定義がない。
%kotani2 冒頭に書きました。
\begin{eqnarray}
\Pi_{\mu \nu}({\bf q},\omega)
&&=
\sum^{\rm BZ}_{\bfk} \sum^{\rm occ}_{n \ispone} \sum^{\rm unocc}_{n'\isptwo}
\frac{
\langle E^{\bf q}_\mu \Psikn |\Psi_{{\bf q+k}n'} \rangle
\langle \Psi_{{\bf q+k}n'}| \Psikn E^{\bf q}_\nu \rangle
}{\omega-(\varepsilon_{{\bf q+k} n'\isptwo}-\varepsilon_{\bfk n\ispone})+i \delta} \nonumber\\
&&+ \sum^{\rm BZ}_{\bfk} \sum^{\rm  unocc}_{n \ispone} \sum^{\rm occ}_{n'\isptwo}
\frac{
\langle E^{\bf q}_\mu \Psi_{{\bf k}n} |\Psi_{{\bf q+k}n'} \rangle
\langle \Psi_{{\bf q+k}n'}| \Psi_{{\bf k}n} E^{\bf q}_\nu \rangle
}{-\omega-(\varepsilon_{\bfk n\ispone}-\varepsilon_{{\bf q+k} n'\isptwo})+i \delta}.
\label{eq:polf0}
\end{eqnarray}
When time-reversal symmetry is assumed, $\Pi(\omega)$ can be simplified to read
\begin{eqnarray}
\Pi_{\mu \nu}({\bf q},\omega)
&&=\sum^{\rm BZ}_{{\bf k}}  \sum^{\rm  occ}_{n} \sum^{\rm  unocc}_{n'}
\langle E^{\bf q}_\mu \Psi_{{\bf k}n} |\Psi_{{\bf q+k}n'} \rangle
\langle \Psi_{{\bf q+k}n'}| \Psi_{{\bf k}n} E^{\bf q}_\nu \rangle \nonumber \\
&& \times
\left(\frac{1}{\omega-\varepsilon_{{\bf q+k}n'}+\varepsilon_{{\bf k}n}+i \delta}
-\frac{1}{\omega+\varepsilon_{{\bf q+k}n'}-\varepsilon_{{\bf k}n}-i \delta}\right). \label{dieele}
\label{eq:polf}
\end{eqnarray}
To evaluate \req{eq:polf0} or \req{eq:polf},
we first accumulate its imaginary parts (anti-Hermitian part) of $\Pi_{\mu \nu}(\bfq,\omega)$
along bins of histograms on the real axis $\omega$
with the tetrahedron technique \cite{rath_generalized_1975},
and then determines the real part via the Hilbert transformation.
The bins are dense near the Fermi energy and coarse at high energy as described in 
Ref.\onlinecite{kotani_quasiparticle_2007}.
This procedure is not only more efficient but also safer than methods
to calculate the real part directly. 
We also use the extended irreducible zone (EIBZ) 
symmetrization procedure described in Ref.\cite{friedrich_efficient_2010}.

The correlation part of the screened Coulomb interaction $W^c(\omega)=W(\omega)-v$, 
which is calculated from $v$ and $\Pi(\omega)$ is given as
\begin{eqnarray}
W^{\rm c}(\bfk,\omega)=\sum_{\mu\nu} | E^{\bfk}_\mu \rangle {W^{\rm c}_{\mu\nu}(\bfk,\omega)} 
\langle E^{\bfk}_\mu |.
\end{eqnarray}
With this $W^{\rm c}(\bfk,\omega)$, we have the correlation part of the self-energy  as
\begin{eqnarray}\
\Sigma^{\rm c}_{n,n'}(\bfq,\omega)= \sum_{\bfk,m} \int_{-\infty}^\infty  \!d \omega' \sum_{\mu,\nu} 
\frac{\langle\Psiqn|\Psiqkm E^{\bfk}_\mu \rangle 
W^{\rm c}_{\mu\nu}(\bfk,\omega')\langle E^{\bfk}_\nu \Psiqkm
|\Psiqnp\rangle e^{-i \delta \omega'}}
{\omega-\omega'-\epsilon_{\bfq-\bfk m}\pm i \delta}.
\label{sigmann}
\end{eqnarray}
\end{widetext}
Here, we use $+i \delta$ for occupied states of
${\bfq\!-\!\bfk m}$, $-i \delta$ for unoccupied states.
In QSGW, 
we have to calculate Hermitian part of $\Sigma_{nn'}(\bfq,\epsilon_{\bfq n})$, 
in order to obtain $\vxc_\bfq$ via \req{eq:vxceq}.

There are two key points to handle the $GW$ procedure given above.
The first key point, given in Sec.\ref{sec:kint},
is the improved offset-$\Gamma$ method which treats
divergence of $W^{\rm c}(\bfk \to 0,\omega)$ in \req{sigmann}. 
For this purpose, we define non-divergent 
effective interaction $\overline{W^{\rm c}}(\bfk=0,\omega)$ instead of
${W^{\rm c}}(\bfk=0,\omega)$.
%; for \req{eq:sigx}, so does $\overline{v_{\mu=1}}(\bfk=0)$ instead of ${v_{\mu=1}}(\bfk=0)$.
Then we can take simple discrete sum for both expressions of \req{eq:sigx} and \req{sigmann}.

The second point in Sec.\ref{sec:siginterp} is
how to make 
%$\vxc_\bfq$ for $\bfq$ in the whole BZ.
%That is, we need to make 
an interpolation to give $\vxc_\bfq$ at any $\bfq$ in the whole BZ,
from $\vxc_\bfq$ calculated only at limited numbers of $\bfq$ points.
This is required in the offset-$\Gamma$ method shown in Sec.\ref{sec:kint},
that is, we have to calculate eigenfunctions at some $\bfq$ points near $\bfq=0$.
For the interpolation, we expand the static
non-local potential $\vxc$ in \req{eq:vxceq} in the highly-localized
MTOs in the real space. Thus the MTOs are used for two purposes;
one is as the bases for the eigenfunctions, the other is as the bases to
expand $\vxc$. The interpolation procedure of $\vxc_\bfk(\bfr,\bfr')$
becomes stabilized and simplified rather than the
complicated interpolation procedure in 
Ref.\onlinecite{kotani_quasiparticle_2007}.
This is because we now use highly localized MTOs.
In the planewave-based \QSGW\ method by Hamann and Vanderbilt \cite{hamann09}, 
they expand $\vxc$ in the maximally localized Wannier functions instead of the MTOs.

%xxx2011 
%(theoryの章から移動ーーー)
%kino1 よくやるのは対応付けて括弧に入れるやり方。
%kotani2 了解しました。ただ、$V^{\rm xc}_{\rm LDA}$をGGAの場合もつかうので、以下のようにしてみました。
%kotani2 potential $V^{\rm xc}_{\rm LDA}$ ($V^{\rm xc}_{\rm GGA}$)is
%used in order to generate core
%kotani2 --->いちおうLDA/GGAの意味をかくということで承諾してもらった。
In practical implementation, the LDA or GGA exchange-correlation
potential $V^{\rm xc}_{\rm LDA}$ 
is used as an assistance in order to generate core
eigenfunctions and also the radial functions within the MTs
(in this paper, we use subscript LDA even in the GGA. ``LDA/GGA'' means LDA or GGA).
%xxx2012
%kino1 In addition, the difference $\vxc-V^{\rm xc}_{\rm LDA}$ is used 
%kino1 in additionが変。
%kotani2 変でしょうか？ LDAかGGAがどこにあらわれるか？という点でまとめたつもりでした。
The difference $\vxc-V^{\rm xc}_{\rm LDA}$ is used 
for the interpolation procedure in the BZ (explained in Sec.\ref{sec:siginterp}),
because this difference is numerically small 
as long as $V^{\rm xc}_{\rm LDA}$ is not so bad approximation.
%kino1 These procedure with using $V^{\rm xc}_{\rm LDA}$ as an assist for numerical
%kino1 calculations give a slight dependence to the final numerical
%results
%取り込み済
These procedures with $V^{\rm xc}_{\rm LDA}$ give a slight dependence to
the final numerical results in practice as seen in Sec.\ref{sec:numtest},
although the results formally does not depend on the LDA/GGA exchange-correlation functions anymore.
%xxx2013
%although the results formally doesn't depend on the LDA/GGA exchange-correlation functions anym%ore.
%kino1 。式でinitial valueですから、relateはしているんです。
%kotani2 了解しました.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{widetext}
\subsection{行列要素$\langle \psi |\psi M \rangle$の計算}
この行列要素は、上述の$\langle \Psi_{{\bf q+k}n} |\Psi_{{\bf q}n'} E^{\bf q}_\mu  \rangle$
などのことを指している。
（英文の部分と統一性が取れていないかも。また記述が古くなっている可能性があ
る。とくに、以前のバージョンでは$M_{{\bf q}I}(\bfr)$を用いていたが、
今のものでは$E^{\bf q}_\mu (\bfr)$を用いた行列要素を計算している。）

hsfp0\_sc.m.F, hx0fp0\_sc.m.Fなどがメインルーチンである。
この中のpsicb,melpln,drvmelp2などのサブルーチン目標は、
最終的にzmelに格納される
「行列要素$\langle\Psikqn(\bfr)|\Psi_{\bfk n'}(\bfr) M_{{\bf q}I}(\bfr)\rangle$」
を求めることである。MPBの$M_{{\bf q}I}$はPBとIPW(QGcou)からなる;
これらは$B_{\bfq Rm}(\bfr-\bfR)$と$P^{\bf k}_{\bf G}({\bf r})$など
と書かれる。（IPWは,波動関数展開のIPW(QGpsi)とMPBに使うIPW(QGcou)と二種類あるので区別しないといけない）。
plnとかmelpという文字の入ったルーチンはIPWに関わる部分である。
hsfp0*,hx0fp0*などにおいては、この行列要素を計算したのちに、
それを用いて、誘電関数やら、自己エネルギーを計算することになる。

以前、場合によっては、これらをすべてファイルにおとして
プログラムとして分割することも考えたが、メモリの関係で
オンザフライで求めている。drvmelp2がsxcfの方にのみ組み込まれているなど、
かなりごちゃごちゃした形になっている。すっきりさせたい。
高度な並列化を考える場合にはこの行列要素計算の並列化も必要になってくるか
と思う。計算量のオーダー的には、N$^3$だろう。\\

smbasis()は以前に開発した新たなMPBだがあまりご利益がないのでいまは使っていない。
これは、MT内とMT外がスムーズにつながるようなMPBのアイデア。
たぶん動かないし放置でいいが、記録として残してある。将来的には
『「MTO基底の積」＋「APW（MT内部のaugmentの仕方は配慮する）』
をあらたなMPBにしたいと考えてはいる。\\

GWコードではiclass(i)=iatomp(i)となっており、多くのことろでiclassはダミー
である。ただ、CLASSファイルに等価原子位置の情報が格納されており、これを
読み込んで波動関数を空間群で回転させるときなどに使っている。

以下、個別のルーチンの説明。\\


\noindent {\bf psicb\_v3:} \\
（注意：コア波動関数とバレンス波動関数の直交性の問題がある。なので、最近は、
「ncore=ncc=0として分極関数にコアからの寄与をいれない」のをデフォルトにしている。
なのでhx0fp0*内では実質的にスキップすることになる；なのであまり以下の説明を読む必要はない）。\\
%We usually set ncore=0, that is, we essentially skips this routine in hx0fp0*.
%Thus we do not include polarization due to cores.)
このサブルーチンではmatarix element 
$\langle\Psikqn(\bfr)| \varphi^{\rm core}_{\bfk n'}(\bfr) B_{\bfq Rm}(\bfr-\bfR) \rangle$
および
$\langle\varphi^{\rm core}_{\bfk+\bfq n}(\bfr)| \Psi_{\bfk n'}(\bfr) B_{\bfq Rm}(\bfr-\bfR) \rangle$
%``core$\times$valence$\times$product basis''
を求める；これは最終的にzpsi2b(iblochq,ib1k,ib2qk)に格納される。
ここで、$\varphi^{\rm core}_{\bfk n}(\bfr)$はブロッホ和\req{eq:blochsum}の形で与えられた
コア波動関数を意味している。このとき$n$はバンドindexとみてよい
(コアについては、$n$は「原子サイト$R$、角運動量$L$、主量子数」からなる複合indexである）。

iblochは1:nblochで、nblochは、すべての原子についてのPBの個数の和である。
なので、nblochは、$B_{\bfq Rm}$における添字$Rm$の要素数でもある。
$R$はユニットセルの原子数、$m$のサイズは原子によって違っている
「各原子についてのPBの数」は”grep nbloch lbas”で表示される。

ib1kとib2kはバンドindexで、ib1kが1:nctotの間,ib2kが1:nccの間にあれば、そ
れらはコア波動関数である。またib1k,ibk2がぞれぞれnctot,nccよりも大きけれ
ば、それらはバレンス波動関数のindexとなっている。（なので、これらのindex
についてはコア＋valenceで、通しでnでindexづけされている）。コアとしてどれだ
けのものをとるかはGWinputで指定できるがコアなしnctot=ncc=0がデフォルト。
（そもそもはnccはゼロで、ib1kが占有バンド、1b2qkは非占有バンドを表してい
たが、time-reversalを破る場合に都合が悪くなり、nccもあとから付け足した経緯がある）。

用いている式は、
\begin{eqnarray}
\langle\Psikqn(\bfr)| \varphi^{\rm core}_{\bfk n}(\bfr-\bfR) B_{\bfq Rm}(\bfr-\bfR) \rangle
= \sum_{u} \alpha^{\bfk+\bfq n}_{Ru} 
\langle \varphi^{\bf k+q}_{Ru}(\bfr)|\varphi^{\rm core}_{{\bf k} n}(\bfr) B_{\bfq Rm}(\bfr) \rangle
= \sum_{u} \alpha^{\bfk n}_{Ru} 
\langle \varphi_{Ru}(\bfr)|\varphi^{\rm core}_{n}(\bfr) B_{Rm}(\bfr) \rangle
\nonumber \\
\end{eqnarray}
である.　$\langle\varphi^{\rm core}_{\bfk+\bfq n}(\bfr)| \Psi_{\bfk n'}(\bfr) B_{\bfq Rm}(\bfr-\bfR) \rangle$
についても同様である（nccがゼロでない場合）。

　\\

\noindent {\bf psi2b\_v3:} \\
このサブルーチンではmatarix element 
$\langle\Psikqn(\bfr)| \Psi_{\bfk n'}(\bfr) B_{\bfq Rm}(\bfr-\bfR) \rangle$
を求めている。valenceの$\Psi$に関わる部分のみである。用いている式は、
\begin{eqnarray}
\langle\Psikqn(\bfr)| \Psi_{\bfk n'}(\bfr) B_{\bfq Rm}(\bfr-\bfR) \rangle
= \sum_{u} \sum_{u'} \alpha^{\bfk+\bfq n}_{Ru} \alpha^{* \bfk n'}_{Ru'}
\langle \varphi^{\bf k+q}_{Ru}(\bfr)|\varphi^{\bf k}_{Ru'}(\bfr) B_{\bfq
Rm}(\bfr) \rangle \nonumber \\
=
\sum_{u} \sum_{u'} \alpha^{\bfk+\bfq n}_{Ru} \alpha^{* \bfk n'}_{Ru'}
\langle \varphi_{Ru}(\bfr)|\varphi_{Ru'}(\bfr) B_{Rm}(\bfr) \rangle
\end{eqnarray}
である。変数cphikには$\alpha^{\bfk n'}_{Ru'}$が格納されている。cphikqについても同様である。
ppbに$\langle \varphi_{Ru}(\bfr)|\varphi_{Ru'}(\bfr)
B_{Rm}(\bfr)\rangle$が格納されている；これは実関数である（実球面調和関数、実数のradial関数を使っているので）。
ppb(nc+1,...)などとなっているのはncがコアの数でその分オフセットする必要があるからである。\\


\noindent {\bf melpln2:}\\
名前はmatrix element for plane waveを略したつもりで、melplnになった。
このルーチンでは、
$\langle\Psikqn(\bfr)| \Psi_{\bfk n'}(\bfr) P^{\bf q}_{\bf G}({\bf r}) \rangle$
を求めている。なので、これと、psi2b\_v3,psicb\_v3などの結果とあわせて、すべてのzmelを求めたことになる。
使っている式は、
\begin{eqnarray}
\langle\Psikqn(\bfr)| \Psi_{\bfk n'}(\bfr) P^{\bf q}_{\bf G}(\bfr) \rangle
= \sum_{G'} \sum_{G''} \beta^{\bfk+\bfq n}_{\bfG} \beta^{* \bfk n'}_{\bfG'}
\langle P^{\bf k+q}_{\bf G'}(\bfr)| P^{\bf k}_{\bf G''}(\bfr) 
P^{\bf q}_{\bf G}({\bf r}) \rangle \label{eq:ppip} 
\end{eqnarray}
であるが、この最後の部分は
\begin{eqnarray}
\langle P^{\bf k+q}_{\bf G'}(\bfr)| P^{\bf k}_{\bf G''}(\bfr) 
P^{\bf q}_{\bf G}({\bf r})\rangle
=\langle \exp(i (\bfG'- \bfG'')\bfr) |\exp(i \bfG\bfr)\rangle_{\rm I}
\label{eq:ppx}
\end{eqnarray}
と書ける。ここで最後の$\langle ... \rangle_{\rm I}$はinterstitialのみでの積分を表す。
この行列要素は、その足が$(\bfG'- \bfG'', \bfG)$となっている。
$\bfG'- \bfG''$の取りうる範囲は、波動関数の積であり、その絶対値は2倍の大きさまでとり
得ることになる。この\req{eq:ppx}の行列要素が、ppx(1:ngc2,1:ngc)である。ngcは、
QGcouに対応するIPWの個数である。ngc2は、$\bfG'- \bfG''$の取りうる範囲の
個数であり、およそ2$^3$倍になっている。
getppxをコールすると、ppxに値が格納される仕組みになっている
（モジュールを用いている。便利だけど分かりにくい）。

計算手順としては、まず、
$\beta^{\bfk+\bfq n}_{\bfG} \beta^{* \bfk n'}_{\bfG'}$
の積を作ってgg(n,n',$\bfG-\bfG'$)に格納している。
そのあと最後に、call matm(ppx,gg,zmelp,ngc,ngc2,ntp0*nt0)
を行って、この\req{eq:ppip} の左辺を得ている。

このルーチンの面倒な点は、エネルギーカットオフをしているので
$\bfq$点ごとに、$\bfG$のとりうる範囲がちがうことである。
それで、PPOVLファイル内のppxも$\bfq$ごとに作り直しており、
ファイルがそれで巨大になってしまっている(PPOVLはrdata4gw.m.Fで作っている)。

ただこれは、ばかげたやりかたです；　範囲が違うだけであって、ppxすなわち
$\langle \exp(i (\bfG'- \bfG'')\bfr) |\exp(i \bfG\bfr)\rangle_{\rm I}$
の値自体は、$\bfG'- \bfG''-\bfG$のみに依存しているだけで,
そんなに大きいことはなく、$|\bfG(\Psi)+|\bfG(\Psi)|+|\bfG({\rm Coulomnb})|$よりも小さなGに対して、
積分を計算しておけばいいはずである。このあたり作り方がへたすぎる。
それから、すぐにggxは作れるはずである。

shtvはhx0fpのほうではゼロにセットされているようである。\\

\noindent {\bf drvmelp2:}\\
このルーチンは、melpl2を被って便利になるように作った。ドライバーというつもり。
本来はたぶん、hx0fp0\_scでも使うつもりだったとおもうが中途半端なことになって
いる。あまり多重にサブルーチン化してもご利益はなく、やめたほうがいいのかもしれない。

\end{widetext}

\subsection{Improve offset-$\Gamma$ method}
\label{sec:kint}

\subsection{Interpolation of the self-energy in the Brillouin zone}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\section{smooth Hankel function}
%\label{shankel}
\begin{widetext}
\section{the error due to the separable form}
\label{sec:zeroonetwo}
To evaluate matrix element of a quasilocal operator
$X(\bfr,\bfr')$, we use separable form $0X 0'+1 X 1'-2 X 2'$
instead of $(0+1-2)X(0'+1'-2')$ under the condition (A') 
(see \refsec{sec:3compo}). Here $0,1,2$ means the three components of 
a eigenfunction as a 3-component function defined in
\refsec{sec:3compo}, $0',1',2'$ as well.

We have an error because of the separable form.
Here we reorganize the discussion to evaluate the error
\cite{soler89,PAW} to fit to the formalism in this paper.
The error can be evaluated with an identity as;
\begin{eqnarray}
(0+1-2)X(0'+1'-2')-(0X 0'+1 X 1'-2 X 2') 
= (0-2)X(1'-2')+(1-2)X(0'-2'), \label{eq:zeroonetwo}
\end{eqnarray}
\end{widetext}
%We take these are 
%conttributions of a 3-component function within a MT site.
%If the right-hand side of \req{eq:zeroonetwo} is negligible,
%we can use the separable form $0 X 0'+1 X 1'-2 X 2'$,
%instead of $(0+1-2)X(0'+1'-2')$. 
Let us examine the error as the right-hand side of
\req{eq:zeroonetwo} under the assumption that $X$ is nearly spherical.
Remember that $(0-2)$ is completely zero if the condition (A) is
satisfied. When the condition (A') is satisfied instead, 
i.e., when we introduce the finite truncation parameters 
$l_{{\rm max},a}$ and $k_{{\rm max},a}$ (given after \req{f2}), 
we can expect that $(0-2)$ should contain high-energy remnant
(high angular momentum $l$ or highly oscillating remnant) with a small amplitude.
The remnant $(0-2)$ for each $L$ is largest at the MT boundaries.
In contrast, when (A') is satisfied, $(1'-2')$ is low energy part which  
converges quickly on the truncation parameters. 
The value and slope of $(1'-2')$ are zero at MT boundaries.
Thus we can expect the product $(0-2)(1'-2')$ should be small and
nearly orthogonal, i.e.,
$\delta n_a(\bfr)=(0-2)_a(1'-2')_a$ should satisfy $\int_a d^3 r\delta
n_a(\bfr)Y_L(\hat{\bfr}) \approx 0$ for low $L$.
Here suffix $a$ means quantities within MT at $\bfR_a$.
Based on these considerations we expect that the error affects little 
the total energy.
This can be checked by changing the truncation parameters within the PMT method.

This logic is applicable not only to the products of the eigenfunctions, 
but also to the electron density for the Coulomb interaction 
with some modifications.

%Then we expect that $(0-2)$ is becoming zero although $(1'-2')$,
%which contains only the low energy part changes little, when
%we enlarge the cutoffs.

%In practice, it is possible to use relatively small angular 
%momentum cutoff as $l_{{\rm max},a}\sim 4$ \cite{lmfchap}.

\begin{widetext}
\section{Atomic Force}
\label{sec:force}
全エネルギーの評価において、入力の電子密度$n_{\rm in}$に対して、
ポテンシャル$V=\frac{\partial (E_{\rm es} + E_{\rm xc})}{\partial n}$
を求め、それをハミルト二アンにもちいて、それの固有値問題を解き、固有値の和としてバンド
エネルギー$E_{\rm B}$を求めることができる。
また、その固有値問題の波動関数から電子密度$n_{\rm out}$を求めることができる。
収束すれば$n_{\rm in}=n_{\rm out}$が成り立っているが、収束途上ではなりた
たない。$n_{\rm in}\ne n_{\rm out}$のとき、
$n_{\rm in}$の汎関数としての全エネルギー(Harris energy)を考える。\\

Harris energy $\ehf$を与えておく。
これは、完全な収束に至らない段階においても、収束したエネルギーを予測して
計算する方法である \cite{molforce,harris85},
収束していない場合、入力電子密度$\nin$とそれによって定められる$V$、
そしてその$V$を用いて対角化計算によって得られて電子密度$\nout$を考える
必要がある。$\ehf$は\req{eq:ebhf}で与えられる。
ここで、$E_{\rm B}$はバンドエネルギーと呼ばれる。
$\alpha_i^p$は
$\langle F_i|H^{\rm in}|F_j \rangle=
\langle F_i| \frac{-\Delta}{2m} + V[\nzc+\nin,\bfR_a] |F_j\rangle$
の固有ベクトルである。それで、$\epsilon_p$をその固有値として、$E_{\rm B}=\sum^{\rm occupied}_p$
と与えられる。また以下のatomic forceの計算のため、$\bfR_a$依存性を陽に書
き込んである。この\req{eq:ehf}における$\bfR_a$依存性は$\MM$-transformation、$\calR$-mappingに起因してい
る。たとえ$\nzc+\nin$が固定されていても、
$\bfR_a$-dependence は Eqs.(\ref{eq:barn0zcv},\ref{eq:calqdef})を通じて、
\req{eq:v}の中に入ってくる。また$\nzc+\nin$を通じての$\bfR_a$-dependence
もある。

First, we define the Harris energy $\ehf$ \cite{molforce,harris85} 
which is the total energy of a functional of the density; this gives
a reasonable estimate of the total energy even when the density is
somehow different from the converged density.
When not being converged yet, the input density $\nin$
must be treated as one generating the one-particle potential $V$,
and output density $\nout$ which is given from eigenfunctions
obtained from the eigenvalue problem of $V$. Here, $
V$ is given by \req{eq:v}. Now, $\ehf$ in the frozen core
approximation as a functional of $\nin$ is defined by \cite{molforce}:
\begin{eqnarray}
&&\ehf = E_{\rm k}^{\rm core} + E_{\rm B} - V[\nzc+\nin,\bfR_a] \cdot \nin 
+ E_{\rm es}[\nzc+\nin,\bfR_a] + E_{\rm xc}[\nzc+\nin],
\label{eq:ehf} \\
&&E_{\rm B} = \sum_p^{\rm occupied}
\alpha_{p}^{i*} 
\langle F_i|H^{\rm in}|F_j \rangle 
\alpha_p^j,
\label{eq:ebhf}
\end{eqnarray}
where $E_{\rm B}$ is the band energy.
$\alpha_i^p$ is the eigenvector of 
$\langle F_i|H^{\rm in}|F_j \rangle=
\langle F_i| \frac{-\Delta}{2m} + V[\nzc+\nin,\bfR_a] |F_j\rangle$.
Thus we have $E_{\rm B}=\sum^{\rm occupied}_p \epsilon_p$, where $\epsilon_p$ are eigenvalues.
The $\bfR_a$-dependence explicitly shown in \req{eq:ehf} is
through the $\MM$-transformation and $\calR$-mapping;
even when $\nzc+\nin$ is fixed as a 3-component function,
$\bfR_a$-dependence is introduced to \req{eq:v} through Eqs.(\ref{eq:barn0zcv},\ref{eq:calqdef}).
In addition, we have $\bfR_a$-dependence through $\nzc+\nin$.

Atomic forces are given as the change of the total energy 
for atomic displacement $\delta \bfR_a$.
Here let us consider the change of $\ehf$, written as $\delta \ehf$.
To obtain $\delta \ehf$, we use the derivative chain rule where we
treat $\ehf$ as a function of $\bfR_a$ through
$\{F_i(\bfr), \nin, \Vin, \bfR_a\}$; $\Vin$ means $V[\nzc+\nin,\bfR_a]$ in 
Eqs.(\ref{eq:ehf},\ref{eq:ebhf}).
Remember that there is $\bfR_a$ dependence through $\nzc$.
Here we assume the partial waves
($\{\phi_{al}(r),\dot{\phi}_{al}(r),\philo(r) \}$ in the case of the PMT
method) are not dependent on atomic positions as in Ref.\cite{molforce}.

Let us evaluate $\delta \ehf$. 
As for $E_{\rm B}=\sum_p^{\rm occupied} \epsilon_p$ 
as a functional of $\{F_i(\bfr),\Vin\}$, perturbation theory on
\req{eq:eigenp} gives
\begin{eqnarray}
&&\delta E_{\rm B} = \sum_p^{\rm occupied} \delta \epsilon_p
=\sum_p^{\rm occupied} \sum_i \sum_j 
\alpha_{p*}^i (\delta H_{ij} -\epsilon_p \delta O_{ij}) \alpha_p^j
=\delta \Vin\cdot \nout + \delta E_{\rm B}^{\rm Puley}, \label{eq:deleb}\\
&&\delta E_{\rm B}^{\rm Puley}=\sum_p^{\rm occupied} \sum_i \sum_j 
\alpha_{p}^{i*} (\delta H^F_{ij} -\epsilon_p \delta O^F_{ij}) \alpha_p^j,
\end{eqnarray}
where we have used $\delta (\Vin\cdot F^*_i F_j)=\delta \Vin 
\cdot F^*_i F_j + \Vin\cdot \delta (F^*_i F_j)$.
$\delta E_{\rm B}^{\rm Puley}$ is calculated from 
$\delta F_{0i}(\bfr)$ and $\delta C^i_{akL}$, which 
are given as a functional of $\delta \bfR_a$.

Since $E_{\rm es} + E_{\rm xc}$ is a functional of $\{\nin,\bfR_a\}$, we have
\begin{eqnarray}
&&\delta \ehf = \delta E_{\rm B} - \delta (\Vin \cdot \nin) 
  + \delta (E_{\rm es} + E_{\rm xc}) \nonumber \\
&&= \delta \Vin \cdot (\nout- \nin) 
  + \delta E_{\rm B}^{\rm Puley} 
  + \left.\frac{\partial (E_{\rm es} + E_{\rm xc})}{\partial \bfR_a}\right|_{\nin} \delta \bfR_a.
\label{eq:deltaehf} 
\end{eqnarray}
%Note that a contribution to $\bfR_a$-dependence is through $\nzc$.
There are three terms in the right hand side of \req{eq:deltaehf}.
The first term appears because $\ehf$ is not converged yet.

To calculate the first term, we need to know $\delta \nin$ which determines
$\delta \Vin$. When the self-consistency is attained and converged,
that is, $\nin=\nout$, $\delta \bfR_a$ uniquely determines
$\delta \nin=\delta \nout$.
However, this is not true when $\nin \ne \nout$.
In this case, there is no unique way to determine $\delta \nin$
for given $\delta \bfR_a$. Thus we need an extra assumption to
determine it. As a reasonable and convenient choice,
we use $\delta \nin=0$ in the sense of 3-component representation. 
Physically, this means that $n_{1,a}(\bfr)-n_{2,a}(\bfr)$  
together with frozen core centered at $\bfR_a$
moves rigidly to $\bfR_a+\delta\bfR_a$.
Then we can calculate corresponding $\delta \Vin$ through the change
$\delta \barnzcv_0$ in \req{eq:v}. $\delta \barnzcv_0$ is evaluated from
\req{eq:barn0zcv},
where note that $\nzc_0(\bfr)$ contains $\bfR_a$ dependence as
given in \req{eq:nzc}.

最後のパラグラフ（Forceの補正項）:\\
Forceを計算するには、Harris-Folkner energy(Harris energyと同義)$E_{\rm Harris}$の変分を
電子密度が完全にはself-consistentになってないとき、
とることを考えてやらねばならない。これは、\req{eq:deltaehf} 
を計算することになる。ここで、第一項における$\delta V$としては、
$\bfR_a$を動かしたときに、どれだけのポテンシャル変化があるかを'適当に仮
定した電荷の変化'から求める。これは$n_{\rm out}-n_{\rm in}=0$で
あれば消える項であり、それなりに適切に推定できていれば十分である。
いくつかのオプションがありえるがまず単純なものは電荷の
第1,2成分のみがrigidにシフトするというものである。
これは、bndfp-dfrceによって評価されている。計算効率を
あげるため、電子系を完全には収束させずに原子位置の緩和をおこなう
必要があるが、その際、この補正は非常に重要である。

\section{onsite matrix}
\label{onsitematrix}
Here we summarize expressions of one-center matrix for $O_{ij},T_{ij}$, and
$V_{ij}$. These are essentially the same as what is shown in Ref.\cite{lmfchap}.
With the help of Eqs.(\ref{f2},\ref{f1}), Eqs(\ref{eq:norm},\ref{eq:kin},\ref{eq:v})
are reduced to be
\begin{eqnarray}
O_{ij} &=&\int_\Omega d^3r  F^*_{0i}(\bfr)F_{0j}(\bfr)
  + \sum_{akk'L} C^{*i}_{akL} \sigma_{akk'L} C^{j}_{akL}   \label{eq:normmat1}\\
T_{ij} &=&\frac{1}{2m_e}\int_\Omega d^3r  \nabla F^*_{0i}(\bfr) \nabla F_{0j}(\bfr)
  + \sum_{akk'L} C^{*i}_{akL} \tau_{akk'L} C^{j}_{ak'L},   \label{eq:kinmmat1}\\
V_{ij}&=&\int_\Omega d^3r  F^*_{0i}(\bfr)V_0(\bfr)F_{0j}(\bfr)
  + \sum_{akk'LL'} C^{*i}_{akL} \pi_{akk'LL'} C^{j}_{ak'L'} \label{eq:vpot},
where
\end{eqnarray}
\begin{eqnarray}
&&\sigma_{akk'l}= \inta d^3r  
 \left(\widetilde{P}_{akL}(\bfr) \widetilde{P}_{ak'L}(\bfr)
- {P}_{akL}(\bfr) {P}_{ak'L}(\bfr)\right), \label{matsig} \\
&&\tau_{akk'l}= \frac{1}{2m_e}\inta d^3r  
 \left(\nabla \widetilde{P}_{akL}(\bfr) \nabla \widetilde{P}_{ak'L}(\bfr)
-\nabla {P}_{akL}(\bfr) \nabla {Pq}_{ak'L}(\bfr)\right), \label{mattau}\\
&&\pi_{akk'LL'}= \sum_M Q_{kk'LL'M} {\cal Q}^{\rm v}_{aM} +
  \left(\barnzcv_{1,a} \circ \RR + v^{\rm xc}_{1,a} \right)\circ
  \widetilde{P}_{akL}(\bfr') \widetilde{P}_{ak'L}(\bfr')
- \left(\barnzcv_{2,a} \circ \RR + v^{\rm xc}_{2,a} \right) \nonumber \\
&&\circ
  {P}_{akL}(\bfr') {P}_{ak'L}(\bfr'), \label{matpi}\\
&&Q_{kk'LL'M}=\inta d^3r
\left( \widetilde{P}_{akL}(\bfr) \widetilde{P}_{ak'Ll}(\bfr)
- {P}_{akL}(\bfr) {P}_{ak'Ll}(\bfr)\right) \YY_M(\bfr) \label{qmom}. 
\end{eqnarray}
\end{widetext}
Note that $\sigma_{akk'l}$ and $\tau_{akk'l}$ are dependent only on
$l$ of $L=(l,m)$.
In Ref.\cite{lmfchap}, this $\pi_{akk'LL'}$ is further divided as
$\pi^{\rm mesh}_{akk'LL'} + \pi^{\rm local}_{akk'LL'}$.
${\cal Q}^{\rm v}_{aM}$ is given by \req{eq:calqdef}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{scalar relativistic approximation in the augmentation}
\label{app:srel}
Roughly speaking, it is allowed to take the scalar relativistic
(SR) approximation (e.g. see \cite{rmartinbook}) if we can safely replace the
non-relativistic (NR) wavefunctions with the SR wavefunctions within MTs.
The SR wavefunctions contain major and minor components. 
The major component should be smoothly connected to the NR wavefunction in 
the interstitial region, where the minority parts are negligible. 
All physical quantities within MT should be evaluated 
through the SR wavefunctions.
In the followings, we explain how the above idea can be implemented in the
3-component augmentation for bilinear products. 

First, we modify the 1st component of the basis. 
We use two component wavefunctions $\{{\mathtt g}_{1i,aL}(\bfr),{\mathtt f}_{1i,aL}(\bfr)\}$
instead of $F_{1i,a}(\bfr)$, where the SR approximation gives
${\mathtt f}_{1i,a}(\bfr)=\frac{1}{2m_e c} \frac{d {\mathtt g}_{1i,a}(\bfr)}{dr}$, 
where $c$ is the speed of light. 
For given $F_{0i}$ and $F_{2i}$ (they are the same as those of the NR case),
we ask the the major components ${\mathtt g}_{1i,a}(\bfr)$
to satisfy the boundary conditions as for value and slope at MT boundaries.
%Then we can determine $\{{\mathtt g}_{1i,aL}(\bfr),{\mathtt f}_{1i,aL}(\bfr)\}$ 
%instead of $F_{1i,a}(\bfr)$.

In order to calculate the contributions due to the 1st components within the SR approximation
instead of the NR approximation, we make a replacement 
$F^*_{1i,a}(\bfr)F_{1j,a}(\bfr') \rightarrow 
 {\mathtt g}^*_{1i,a}(\bfr){\mathtt g}_{1j,a}(\bfr')
+\left(\frac{1}{2m_e c}\right)^2 
 {\mathtt f}^*_{1i,a}(\bfr){\mathtt f}_{1j,a}(\bfr')$.
With this replacement, we can evaluate the density $n$, the matrix $O_{ij}$ 
and so on. This ends up with the total energy in the SR approximation.

Finally, we see that changes are in the replacement Eqs.(\ref{matsig}-\ref{qmom}),
where products $\widetilde{P}_{akL}(\bfr) \widetilde{P}_{ak'L}(\bfr)$ 
(and those with $\nabla$) should be interpreted not only from the products 
of the majority wavefunctions, but also from those of the minority.
This occurs also for the density $n_{1,a}$ included in \req{matpi}.

In such a way we can include the SR effect in the 3-component formalism.
In a similar manner, we can include the spin-orbit coupling in the 1st component, 
which results in the spin off-diagonal contributions \cite{chantis06a}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{choice of a real-space mesh}
\label{sec:realmesh}
(あたりまえな話かもしれない。実際には問題もありえる。読む必要なし)
For example, the smooth part of $E_{\rm xc}$ is evaluated on
the real-space mesh. Thus we wonder whether $E_{\rm xc}$ can be
dependent on choice of a real-space mesh even when we fix the total
number of mesh points. Here we show that there is no 
such dependence on a choice of the mesh.

First, let us specify our problem. We evaluate an integral 
$I=\int_\Omega f(n(\bfr)) d^3r$ as the sum on a discrete real-space mesh 
$\{\bfr_i\}$:
\begin{eqnarray}
I= \sum_{i} f(n(\bfr_{i})). \label{isum}
\end{eqnarray}
We now show $I$ is not dependent on the choice of the real-space mesh
under reasonable conditions.

The conditions are as follows:
\begin{itemize}
\item[(i)]
With finite number of $\{\bfG\}$, we represent $n(\bfr)$ for any $\bfr$ as
\begin{eqnarray}
n(\bfr)= \sum_{\bfG} n_\bfG e^{i \bfG \bfr}.
\end{eqnarray}
\item[(ii)]
Real space mesh $\{\bfr_{i}\}$ should correspond to the Fourier mesh of
$\{\bfG\}$ in the sense that
\begin{eqnarray}
\delta_{\bfG\bfG'}= \sum_{i} e^{i (\bfG-\bfG') \bfr_{i}},\nonumber \\
\delta_{ii'}= \sum_{\bfG} e^{i \bfG(\bfr_i-\bfr_{i'})}.
\end{eqnarray}
(For simplicity, we take $\sum_i$ and $\sum_\bfG$ include a normalization.)
\item[(iii)]
$f(n)$ is analytic on $n$ for positive $n$. This results in
	   an infinite series of expansion as 
\begin{eqnarray}
f(n)\!=\! f(\bar{n}) 
\!+\! f'(\bar{n}) (n-\bar{n}) \!+\! \frac{f''(\bar{n}) }{2!} (n-\bar{n})^2 \!+\!... , \label{fexpand}
\end{eqnarray}
where $f',f''...$ are derivatives with respect to $n$ at $\bar{n}$.
$\bar{n}$ can be average of density.
\end{itemize}

Our statement is that the integral $I$ is dependent on only $n_\bfG$, not
dependent on the choice of $\{\bfr_i\}$ as long as (i),(ii),(iii) are
satisfied. To verify this, it is enough to treat 
$I_m=\sum_i (n(\bfr_i))^m$, because
$I$ is given as a linear combination of $\{I_m\}$
due to (iii). As for $I_m$, we can easily show
\begin{eqnarray}
I_m = \sum_{\bfG_1+\bfG_2+...+\bfG_m=0} n_{\bfG_1} n_{\bfG_2} ... n_{\bfG_m}.
\end{eqnarray}
This means that the choice of real-space mesh do not affect $I_m$
as long as (i) and (ii) are satisfied. Thus our statement is verified.

This can be extended to the cases of GGA. 
This allows us to use relatively coarse mesh to calculate 
atomic forces because we have no artificial forces due to the choice 
of real-space mesh. However, we expect a numerical error when the real-space
mesh is too coarse since the expansion \req{fexpand} cannot be
converged rapidly.


% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \section{choice of a real-space mesh}
% \label{sec:realmesh}
% For example, the smooth part of $E_{\rm xc}$ is evaluated on
% the real-space mesh. Thus we wonder whether $E_{\rm xc}$ can be
% dependent on choice of a real-space mesh even when we fix the total
% number of mesh points. Here we show that there is no 
% such dependence on a choice of the mesh.

% First, let us specify our problem. We evaluate an integral 
% $I=\int_\Omega f(n(\bfr)) d^3r$ as the sum on a discrete real-space mesh 
% $\{\bfr_i\}$:
% \begin{eqnarray}
% I= \sum_{i} f(n(\bfr_{i})). \label{isum}
% \end{eqnarray}
% We now show $I$ is not dependent on the choice of the real-space mesh
% under reasonable conditions.

% The conditions are as follows:
% \begin{itemize}
% \item[(i)]
% With finite number of $\{\bfG\}$, we represent $n(\bfr)$ for any $\bfr$ as
% \begin{eqnarray}
% n(\bfr)= \sum_{\bfG} n_\bfG e^{i \bfG \bfr}.
% \end{eqnarray}
% \item[(ii)]
% Real space mesh $\{\bfr_{i}\}$ should correspond to the Fourier mesh of
% $\{\bfG\}$ in the sense that
% \begin{eqnarray}
% \delta_{\bfG\bfG'}= \sum_{i} e^{i (\bfG-\bfG') \bfr_{i}},\nonumber \\
% \delta_{ii'}= \sum_{\bfG} e^{i \bfG(\bfr_i-\bfr_{i'})}.
% \end{eqnarray}
% (For simplicity, we take $\sum_i$ and $\sum_\bfG$ include a normalization.)
% \item[(iii)]
% $f(n)$ is analytic on $n$ for positive $n$. This results in
% 	   an infinite series of expansion as 
% \begin{eqnarray}
% f(n)\!=\! f(\bar{n}) 
% \!+\! f'(\bar{n}) (n-\bar{n}) \!+\! \frac{f''(\bar{n}) }{2!} (n-\bar{n})^2 \!+\!... , \label{fexpand}
% \end{eqnarray}
% where $f',f''...$ are derivatives with respect to $n$ at $\bar{n}$.
% $\bar{n}$ can be average of density.
% \end{itemize}

% Our statement is that the integral $I$ is dependent on only $n_\bfG$, not
% dependent on the choice of $\{\bfr_i\}$ as long as (i),(ii),(iii) are
% satisfied. To verify this, it is enough to treat 
% $I_m=\sum_i (n(\bfr_i))^m$, because
% $I$ is given as a linear combination of $\{I_m\}$
% due to (iii). As for $I_m$, we can easily show
% \begin{eqnarray}
% I_m = \sum_{\bfG_1+\bfG_2+...+\bfG_m=0} n_{\bfG_1} n_{\bfG_2} ... n_{\bfG_m}.
% \end{eqnarray}
% This means that the choice of real-space mesh do not affect $I_m$
% as long as (i) and (ii) are satisfied. Thus our statement is verified.

% This can be extended to the cases of GGA. 
% This allows us to use relatively coarse mesh to calculate 
% atomic forces because we have no artificial forces due to the choice 
% of real-space mesh. However, we expect a numerical error when the real-space
% mesh is too coarse since the expansion \req{fexpand} cannot be
% converged rapidly.

\begin{widetext}
\section{電荷の表現などについて}

すこし古く、あまり正確でないかもしれない。リクエストしてください。
\begin{itemize}
\item
lmfにおいてコアになっているのは、bndfp.Fである、このルーチンが一回呼ばれ
ることで、与えられた電子密度からポテンシャルをつくり、バンド計算をおこなっ
て、新たな電子密度を、返す、ということを行う（LDA＋UのときはUも呼び出し
時に与えられる。指定したl-channelの占有数matrixをlmfpの部分で扱っており、
混乱ぎみの構造になっている。）
その際、電荷のmixingや、力の計算なども行うことになる。
このルーチンはlmfp.Fから呼び出される。なので、lmfp.Fのなかにiterationの
ループが存在する；do loopでなくgotoを用いており
（!! === Re-entry point for a new iteration ===）から始まっている。
構造緩和などは、lmfp.Fが担っているが、それらは将来的に
他のものとの差し替えも可能であり、bndfp.F以下が本質的な部分である。

\item 
bndfp-mkpotで与えられた電子密度からポテンシャルを作っている。
bndfpでは$n_{\rm in}$と$n_{\rm out}$を区別して扱っている。
電子密度$n_{\rm out}$は、hamblでバンド計算した後、bndfp-addrblで生成される。
以下のほとんどがbndfpから呼ばれているルーチンの説明である。

\item 
$n_{\rm in}$について。

これのvalenceの部分は、\req{eq:n}で定義された$n$の表示で与えられている。
bndfp内において、
smrho(k1,k2,k2,nsp)が第0成分。第1,2成分はw(orhoat(ix,ibas))に格納し
てある(説明は以下)。コード内ではorhoat=w(oorhoat)なので注意がいる；ポインタ
のポインタの構造。これらがmkpotに渡される。このw(orhoat(ix,ibas))の中身は、
rhoat(nr,nlml,nsp) = w(orhat(ix,ibas))であり、YLM展開の電子密度を
含む。nrがradial mesh,nlmlがL、nspはスピン。ixは1,2,3をとる。
ix=1,2が$n$の第1,2成分に対応している。
第3成分には、$ n^{\rm core}_{\rm true\_onsite}(\bfr)$
が格納されている。

これらに\req{eq:nc}の$n^{\rm c}$を加えれば、全電子密度が得られる。
たとえば、mkpotには、smrho,rhoatが渡され、これらがmkpot内部で付加されて、
全電子密度$n+n^{\rm c}$を作り、それを用いて、交換相関ポテンシャルを生成
する仕組みになっている。このとき、\req{eq:nc}をみればsmooth Hankelの
tailの寄与を付加しなければならないことがわかる。これは下のほうで説明する。

\item
$n_{\rm out}$について。

w(osrout)がsmrho,w(orhoat1(:,:))がw(orhoat(:,:))
に対応する。bndfp-mixrhoが$n_{\rm in}$と$n_{\rm out}$のmixing routine
である[orhat1とw(oorhat)が並べてあり整理されてない].

\item
電子密度は、iodenにおいて書き出されている。
これは、lmfpにおいて、bndfpをcallしたあとに実行される。bndfpの結果の電子密度
がw(osmrho),w(oorhat)を介してわたされる。{\small[このあたりのデータフローの書き
     方もかなり汚い。osmrhoは構造体potに含まれるポインタでこれがupackさ
     れることで、lmfp,bndfpのどちらにおいてもアクセスできることになる。
     Markさんとしたらpotからいれたり出したりしてるわけだが、構造体の乱用
     と思える。構造体ならpot\%smrhoなどになるので少し明瞭。しかし
     fortran2003にならないとallocatable arrayを構造体にいれれない。
     そもそもonce-writeでないものを構造体にいれるのはさけるべき。]}


\item
電子密度$n^{\rm c}+n$を書き出すには、iodenをつかわなくてもいいかもしれない。
確実なやり方は、$V_{\rm xc}$が$n^{\rm c}+n$から作られているところを
調べることである。この部分を改良して電子密度を書き出すのがよいかもしれな
い。開発者も理解しやすいので
[ここを理解しておくと、$V_{\rm xc}$を書き換えるにも都合がよい]。
$V_{\rm xc}$の第0成分は、mkpot-smvxcmで、
$V_{\rm xc}$の第1,2成分は、mkpot-locpot-locpt2でつくられている。
以下、順に説明する。

$n^{\rm c}+n$の第0成分から$V_{\rm xc}$の第0成分は作られる。
これは、mkpot L375あたりで呼び出されるsmvxcmでつくられる(この前に
smvxc2が呼ばれているがこれはvalence部分の寄与を取り出して評価するための
ものであり、おそらく直接にはつかわれていない---GW関連で付け加えた部分)。
通常、lfoca=1では、lfoc1=1,lfoc2=0で動いている。
smvxcmをみると、w(osmrho)にsmrho+w(ogch1)が供給されているのがわかる。
これが、$n_0+n^{\rm core}_{\rm sH}(\bfr)$であり、$n^{\rm c}+n$の第0成分
であって実meshの上で生成されている。
``C ... w(osmrho) = smrho + smoothed core from foca hankel heads''
のブロックが終了した時点でw(osmrho)には、この電子密度が入っている。これを書き出す必要がある。

{\small [ちょっと注意すべきは、w(ocgh1)である。これはその前のsmcormで生成されるが、
cgh1,cgh2の二つの部分にわけて生成されたうちの前者である。このcgh2のほうはlfoca=2の
コアがあるときのみゼロでない（なので通常のlfoca=0,1ではゼロになっている）。
このモードは本書では説明していないが
$n^{\rm core}_{\rm sH}(\bfr)$を摂動的にあつかう方法である。
lfoca=2のときも含めて対応するならcgh1+cgh2をsmrhoに足しておくのがいいか
もしれない---ただlfoca=2は小谷はつかったことがない]}

\item
$n^{\rm c}+n$の第1,2成分から$V_{\rm xc}$の第1,2成分は作られる。
これは、mkpot-locpot-locpt2で生成されている。locpt2内のコメントは
それなりにヒントになるがちょっと煩雑で混乱もある。locpt2に供給されている
のは、$n$の第1,2成分(rho1,rho2)とcoreの成分である(これをrhocと呼んでいる).
$n^{\rm c}+n$の第1,2成分はrho1+rhoc,rho2+rhochsで与えられる。
rhochsについては以下でせつめい。

すこし解説。lfoc=1のブランチに注目する。isw=1はvalenceの寄与
を計算したいときのための補助的ブランチでありisw=0をみればよい。

vxcnspがLDAのXC項を計算するルーチンであるがL813あたりの
``call dpadd(rho2(1,1,isp),rhochs,1,nr,y0/nsp)``で、
rho2=rho2+rhochsとして、vxcnspに与えている。v2が出力される.
これを実行したあとすぐに、rho2からrhochを差し引いてることに注意。

このrhochsが、$n^{\rm c}+n$の第2成分である。\req{eq:nc}の最後の項
(注意：蛇足だが、マイナス符号をとったものが第2成分)。
locpt2内でこのrhochsがどのように生成されるかをみて確認しておくとよい。

\item
mkpot:bndfp内で呼びだす。これが、\req{eq:v}を生成する。
[注意： \cite{lmfchap}は$V^{\rm xc}$の扱いをすこし間違っている。
$V$から、そのなかのEqs.(26)-(29)で、$V_{ij}$が
作れるように書いてある。しかし、これだと、$V^{\rm xc}$に
関してまでも、多重極変換が関係してるような表式になってしまい、間違ってい
る。ただしコードは間違っていない。bndfp-mkpot-locpot-augmat-gaugmにおいては、
gpot0,gpotb(これがポテンシャル$\times r^l Y(\hat{\bfr})$の積分)が
使われているがこれらは静電ポテンシャルのみから計算されている。]

\item
\req{eq:es}の$E_{\rm es}$の第0成分からの寄与は
mkpot.F内のsmves.Fで評価している。
この中で、Gaussian$\times$smooth partの積分やGaussian$\times$Gaussianの積分が出て
くる。後者については、off-siteの部分に関しては、単純に多重極のエバルト和で評価できる。
第1,2成分からの項に関しては、locpot.Fで評価している。\\

\item
callcaller.datにはどのルーチンがどこでdefされどこでcallされてるかの表があ
る（完全には信用しないこと）。これはCallCaller.shで生成できる。
（利用法を書く必要あり）。\\

\item
bndfp-mkekinで$E_k$の計算を行っている。


\end{itemize}
\end{widetext}

\bibliography{lmto,gw}
\end{document}
